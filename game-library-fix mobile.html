<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #14181c;
            color: #9ab;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1f29;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #00c030;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .stat-item {
            color: #678;
        }

        .stat-item strong {
            color: #00c030;
            font-size: 1.2em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: #00c030;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #00e040;
        }

        button.secondary {
            background: #2c3440;
        }

        button.secondary:hover {
            background: #3c4450;
        }

        input, select, textarea {
            background: #2c3440;
            border: 1px solid #456;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00c030;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .filter-controls input {
            flex: 1;
            max-width: 300px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .game-card {
            background: #1a1f29;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 192, 48, 0.3);
            border-color: #00c030;
        }

        .game-cover {
            width: 100%;
            height: 280px;
            object-fit: cover;
            background: #2c3440;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 60px;
            flex-shrink: 0;
        }

        .game-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .game-title {
            color: #fff;
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 8px;
            line-height: 1.3;
            height: 2.6em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .game-meta {
            font-size: 0.85em;
            color: #678;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: auto;
            gap: 8px;
        }

        .game-meta-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }

        .game-playtime {
            font-size: 0.85em;
            color: #9ab;
            white-space: nowrap;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-playing { background: #00c030; color: #fff; }
        .status-daily-driver { background: #00d4d4; color: #000; }
        .status-completed { background: #0080ff; color: #fff; }
        .status-backlog { background: #ff6b6b; color: #fff; }
        .status-on-deck { background: #9b59b6; color: #fff; }
        .status-wishlist { background: #ffd93d; color: #000; }
        .status-abandoned { background: #666; color: #fff; }

        .rating {
            color: #ff8800;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            max-width: 900px;
            margin: 40px auto;
            background: #1a1f29;
            border-radius: 8px;
            padding: 30px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2c3440;
            color: #fff;
            font-size: 28px;
            padding: 8px 15px;
            border-radius: 4px;
            line-height: 1;
            font-weight: bold;
            z-index: 10;
        }

        .close-modal:hover {
            color: #fff;
            background: #3c4450;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9ab;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .game-detail-header {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .game-detail-cover {
            width: 250px;
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
            background: #2c3440;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 80px;
        }

        .game-detail-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-detail-info h2 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .game-detail-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            background: #2c3440;
            padding: 12px;
            border-radius: 4px;
        }

        .meta-label {
            color: #678;
            font-size: 0.85em;
            margin-bottom: 3px;
        }

        .meta-value {
            color: #fff;
            font-weight: 600;
        }

        .sessions-section {
            margin-top: 30px;
        }

        .sessions-section h3 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-card {
            background: #2c3440;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #00c030;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #9ab;
            font-size: 0.9em;
        }

        .session-date {
            font-weight: 600;
        }

        .session-duration {
            color: #678;
        }

        .session-notes {
            color: #fff;
            line-height: 1.5;
        }

        .session-progress {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #456;
            color: #9ab;
            font-size: 0.85em;
        }

        .session-edit-btn, .session-delete-btn {
            background: none;
            border: none;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 0.9em;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .session-edit-btn:hover, .session-delete-btn:hover {
            opacity: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #678;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 1.5em;
        }

        .star {
            cursor: pointer;
            color: #456;
            transition: color 0.2s;
        }

        .star.active,
        .star:hover {
            color: #ff8800;
        }

        .import-export {
            margin-top: 40px;
            padding: 20px;
            background: #2c3440;
            border-radius: 8px;
        }

        .import-export h3 {
            color: #fff;
            margin-bottom: 15px;
        }

        .delete-btn {
            background: #ff4444;
        }

        .delete-btn:hover {
            background: #ff6666;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3440;
        }

        .section-header h2 {
            color: #fff;
            font-size: 1.5em;
            margin: 0;
        }

        .section-count {
            color: #00c030;
            font-size: 0.9em;
            font-weight: 600;
        }

        .expand-button {
            background: #2c3440;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .expand-button:hover {
            background: #3c4450;
        }

        .load-more-container {
            text-align: center;
            margin: 30px 0;
        }

        .load-more-btn {
            padding: 12px 40px;
            font-size: 1em;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 10px 0;
                margin-bottom: 12px;
            }
            
            /* Reorganize header completely on mobile */
            header > div > div:first-child {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            header > div > div:first-child > div:first-child {
                order: 1;
            }
            
            header > div > div:first-child > div:last-child {
                order: 2;
                align-items: stretch !important;
                margin-top: 10px;
            }

            h1 {
                font-size: 1.2em;
                margin-bottom: 8px;
            }
            
            /* Stats filter moved above stats */
            header > div > div:first-child > div:last-child > div:first-child {
                width: 100%;
                margin-bottom: 8px;
            }
            
            header > div > div:first-child > div:last-child > div:first-child label {
                font-size: 0.75em !important;
            }
            
            header > div > div:first-child > div:last-child > div:first-child select {
                padding: 5px 8px !important;
                font-size: 0.8em !important;
            }

            /* Full-width stats in 2x2 grid */
            .stats {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px !important;
                margin-top: 0 !important;
                font-size: 0.7em !important;
                width: 100%;
            }

            .stat-item {
                padding: 6px !important;
                background: #2c3440 !important;
                border-radius: 4px !important;
                text-align: center !important;
            }

            /* Compact user info */
            .user-info {
                flex-direction: row !important;
                flex-wrap: wrap;
                align-items: center !important;
                gap: 4px !important;
                width: 100%;
            }

            .user-email {
                font-size: 0.65em;
            }

            .sync-status {
                margin-left: 0 !important;
                font-size: 0.65em;
            }
            
            #notification-badge {
                padding: 3px 8px !important;
                font-size: 0.7em !important;
            }
            
            #login-btn, #logout-btn {
                padding: 3px 10px !important;
                font-size: 0.7em !important;
            }

            /* Stack action buttons vertically */
            .controls {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .controls > button {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }

            /* Collapsible filters */
            .filter-controls {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .filter-controls input,
            .filter-controls select {
                max-width: 100%;
                width: 100%;
                font-size: 14px;
                padding: 10px;
            }
            
            /* Add filter toggle button */
            #filter-toggle-btn {
                display: block !important;
                width: 100%;
                padding: 10px;
                background: #2c3440;
                border: 1px solid #3c4450;
                color: #9ab;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
                text-align: center;
            }
            
            #filter-toggle-btn:active {
                background: #3c4450;
            }
            
            .filter-controls.collapsed {
                display: none;
            }

            .section-header {
                margin: 15px 0 10px 0;
                padding-bottom: 6px;
                flex-wrap: wrap;
            }

            .section-header h2 {
                font-size: 1.1em;
                width: 100%;
                margin-bottom: 6px;
            }

            .section-count {
                font-size: 0.8em;
            }

            /* 2 COLUMN GRID for mobile with proper vertical cards */
            .game-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .game-card {
                border-radius: 6px;
                flex-direction: column;
                overflow: hidden;
            }

            /* Vertical cover art with proper aspect ratio */
            .game-cover {
                width: 100%;
                aspect-ratio: 2/3; /* Standard game cover ratio */
                height: auto;
                border-radius: 6px 6px 0 0;
            }
            
            .game-cover img {
                border-radius: 6px 6px 0 0;
                object-fit: cover;
                width: 100%;
                height: 100%;
            }

            .game-info {
                padding: 8px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .game-title {
                font-size: 0.8em;
                line-height: 1.2;
                height: auto;
                min-height: 2.4em;
                margin-bottom: 4px;
                font-weight: 600;
            }
            
            /* Tags on mobile - show first 2 only */
            .game-info > div[style*="flex-wrap"] {
                margin-top: 4px !important;
                margin-bottom: 4px !important;
            }
            
            .game-info > div[style*="flex-wrap"] span {
                font-size: 0.6em !important;
                padding: 2px 5px !important;
            }

            .game-meta {
                font-size: 0.7em;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .game-meta-left {
                gap: 4px;
                flex-wrap: wrap;
                width: 100%;
            }

            .status-badge {
                font-size: 0.65em;
                padding: 2px 6px;
            }

            .rating {
                font-size: 0.85em;
                align-self: flex-start;
            }

            .game-playtime {
                font-size: 0.7em;
            }

            /* Form inputs properly sized */
            .form-group {
                max-width: 100% !important;
                overflow: hidden;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                font-size: 14px !important;
            }
            
            .form-group label {
                max-width: 100%;
                word-wrap: break-word;
            }
            
            .form-group small {
                display: block;
                max-width: 100%;
                word-wrap: break-word;
            }
            
            .image-upload-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .image-preview {
                width: 100% !important;
                max-width: 200px !important;
                margin: 0 auto;
            }
            
            .image-controls {
                width: 100%;
            }
            
            .image-controls input,
            .image-controls button {
                width: 100% !important;
                box-sizing: border-box !important;
            }

            .expand-button, #completed-year-filter, #stats-year-filter {
                font-size: 0.75em;
                padding: 6px 10px;
            }

            .load-more-container {
                margin: 15px 0;
            }

            .load-more-btn {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }

            .modal-content {
                margin: 10px;
                padding: 15px;
                max-width: calc(100% - 20px);
                width: calc(100% - 20px);
                box-sizing: border-box;
            }
            
            /* Force all modal content to stay within bounds */
            .modal-content * {
                max-width: 100%;
                box-sizing: border-box;
            }

            .close-modal {
                top: 10px;
                right: 10px;
                font-size: 28px;
                padding: 8px 15px;
                background: #00c030;
            }

            .close-modal:active {
                background: #00a028;
            }

            .game-detail-header {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .game-detail-cover {
                width: 100%;
                height: 300px;
                margin: 0 auto;
            }

            .game-detail-info h2 {
                font-size: 1.3em !important;
                word-wrap: break-word;
            }

            .game-detail-meta {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons button {
                width: 100%;
            }
            
            /* Fix checkbox alignment */
            .form-group label[style*="display: flex"] {
                justify-content: flex-start !important;
                padding-right: 10px;
            }
            
            .form-group label[style*="display: flex"] span {
                flex-shrink: 0;
                word-wrap: normal;
            }
            
            /* Tag sections */
            #selected-tags,
            #tag-suggestions {
                max-width: 100% !important;
                overflow-x: hidden;
            }
            
            /* Image upload section */
            .image-upload-section {
                max-width: 100% !important;
            }
            
            .image-upload-section > div {
                max-width: 100% !important;
            }
            }

            .image-preview {
                width: 100%;
                max-width: 200px;
                height: 250px;
                margin: 0 auto;
            }

            .import-export {
                padding: 15px;
            }

            .import-export > div {
                flex-direction: column !important;
            }

            .import-export button {
                width: 100%;
            }

            button {
                padding: 12px 20px;
                font-size: 16px;
                touch-action: manipulation;
            }

            input, select, textarea {
                font-size: 16px;
                padding: 12px;
            }

            .auth-container {
                margin: 20px;
                padding: 20px;
            }

            .dlc-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .dlc-delete {
                width: 100%;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .game-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .game-cover {
                height: 120px;
            }

            .game-info {
                padding: 6px;
            }

            .game-title {
                font-size: 0.7em;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            h1 {
                font-size: 1.2em;
            }

            .section-header h2 {
                font-size: 1.1em;
            }
        }

        /* Tablet landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .game-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button, .game-card, .star {
                cursor: default;
            }

            button:active {
                background: #00a028;
            }

            button.secondary:active {
                background: #4c5460;
            }

            .game-card:active {
                transform: scale(0.98);
            }
        }

        .storefront-section {
            margin-top: 10px;
        }

        select[multiple] {
            padding: 8px;
            min-height: 120px;
        }

        select[multiple] option {
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        select[multiple] option:checked {
            background: #00c030 linear-gradient(0deg, #00c030 0%, #00c030 100%);
            color: #fff;
        }

        .image-upload-section {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .image-preview {
            width: 120px;
            height: 160px;
            background: #1a1f29;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 40px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dlc-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .dlc-item {
            background: #2c3440;
            padding: 12px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dlc-info {
            flex: 1;
        }

        .dlc-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .dlc-meta {
            font-size: 0.85em;
            color: #678;
        }

        .dlc-delete {
            background: #ff4444;
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .add-dlc-form {
            background: #2c3440;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .add-dlc-form input {
            margin-bottom: 10px;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: #1a1f29;
            border-radius: 8px;
        }

        .auth-container h2 {
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: #2c3440;
            border: none;
            color: #9ab;
            cursor: pointer;
            border-radius: 4px;
        }

        .auth-tab.active {
            background: #00c030;
            color: #fff;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 15px;
        }

        .sync-status.syncing {
            background: #ff8800;
            color: #fff;
        }

        .sync-status.synced {
            background: #00c030;
            color: #fff;
        }

        .sync-status.error {
            background: #ff4444;
            color: #fff;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-email {
            color: #9ab;
            font-size: 0.9em;
        }

        #auth-error {
            color: #ff4444;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Auth Container (shown when not logged in) -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <h2>üéÆ Game Library</h2>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>

        <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" style="width: 100%;">Login</button>
            <div id="auth-error"></div>
        </form>

        <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signup-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signup-password" required minlength="6">
            </div>
            <button type="submit" style="width: 100%;">Sign Up</button>
            <div id="auth-error-signup"></div>
            <p style="color: #678; font-size: 0.85em; margin-top: 10px; text-align: center;">
                You'll receive a confirmation email. Click the link to activate your account.
            </p>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #2c3440;">
            <button onclick="skipLogin()" class="secondary" style="width: 100%;">Continue Offline (No Sync)</button>
            <p style="color: #678; font-size: 0.8em; margin-top: 10px;">
                Use locally with browser storage. Login anytime to sync across devices.
            </p>
        </div>
    </div>

    <!-- Main App (shown when logged in) -->
    <div id="main-app" style="display: none;">
    <header>
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üéÆ Game Library</h1>
                    <div class="user-info">
                        <span class="user-email" id="user-email"></span>
                        <span class="sync-status" id="sync-status">Synced</span>
                        <button id="notification-badge" onclick="showUpcomingReleases()" class="secondary" style="position: relative; padding: 5px 12px; font-size: 0.85em; display: none;">
                            üîî <span id="notification-count" style="position: absolute; top: -8px; right: -8px; background: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold;"></span>
                        </button>
                        <button id="login-btn" class="secondary" onclick="showLoginModal()" style="padding: 5px 15px; font-size: 0.85em; display: none;">Login to Sync</button>
                        <button id="logout-btn" class="secondary" onclick="handleLogout()" style="padding: 5px 15px; font-size: 0.85em;">Logout</button>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #9ab; font-size: 0.85em;">Stats for:</label>
                        <select id="stats-year-filter" onchange="updateStatsFilter()" style="padding: 6px 10px; font-size: 0.9em;">
                        <option value="all">All Time</option>
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
            <div class="stats">
                <div class="stat-item">
                    <strong id="total-games">0</strong> games
                </div>
                <div class="stat-item">
                    <strong id="total-sessions">0</strong> sessions
                </div>
                <div class="stat-item">
                    <strong id="total-hours">0</strong> hours
                </div>
                <div class="stat-item">
                    <strong id="total-spent">$0</strong> spent
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <button onclick="showAddGameModal()">+ Add Game</button>
            <button onclick="showSteamImport()" class="secondary" id="steam-import-btn">üéÆ Import from Steam</button>
            <button onclick="showUpcomingReleases()" class="secondary">üìÖ Upcoming Releases</button>
            <button id="filter-toggle-btn" onclick="toggleFilters()" style="display: none;">üîç Show Filters</button>
            <div class="filter-controls" id="filter-controls">
                <input type="text" id="search-input" placeholder="Search games..." oninput="filterGames()">
                <select id="status-filter" onchange="filterGames()">
                    <option value="all">All Status</option>
                    <option value="playing">Playing</option>
                    <option value="daily-driver">Daily Driver</option>
                    <option value="on-deck">On Deck</option>
                    <option value="completed">Completed</option>
                    <option value="backlog">Backlog</option>
                    <option value="wishlist">Wishlist</option>
                    <option value="abandoned">Abandoned</option>
                </select>
                <select id="priority-filter" onchange="filterGames()">
                    <option value="all">All Priorities</option>
                    <option value="high">üî¥ High Priority</option>
                    <option value="medium">üü° Medium</option>
                    <option value="low">‚ö™ Low</option>
                    <option value="none">No Priority</option>
                </select>
                <select id="tag-filter" onchange="filterGames()">
                    <option value="all">All Tags</option>
                </select>
                <select id="sort-select" onchange="handleSortChange()">
                    <option value="title">Sort by Title</option>
                    <option value="recent">Recently Added</option>
                    <option value="recently-played" selected>Recently Played</option>
                    <option value="rating">Highest Rated</option>
                    <option value="playtime">Most Played</option>
                    <option value="priority">By Priority</option>
                </select>
            </div>
        </div>

        <!-- Playing Now Section -->
        <div class="section-header">
            <h2>üéÆ Currently Playing</h2>
            <span class="section-count" id="playing-count">0 games</span>
        </div>
        <div id="playing-grid" class="game-grid"></div>

        <!-- Daily Driver Section -->
        <div class="section-header">
            <h2>üîÑ Daily Drivers</h2>
            <span class="section-count" id="daily-driver-count">0 games</span>
        </div>
        <div id="daily-driver-grid" class="game-grid"></div>

        <!-- On Deck Section -->
        <div class="section-header">
            <h2>‚è≠Ô∏è On Deck</h2>
            <span class="section-count" id="ondeck-count">0 games</span>
        </div>
        <div id="ondeck-grid" class="game-grid"></div>

        <!-- Completed Section -->
        <div class="section-header">
            <h2>‚úÖ Completed</h2>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="section-count" id="completed-count">0 in 2026</span>
                <select id="completed-year-filter" onchange="filterCompletedYear()" style="padding: 6px 12px;">
                    <option value="all">All Years</option>
                </select>
            </div>
        </div>
        <div id="completed-grid" class="game-grid"></div>

        <!-- Full Library Section -->
        <div class="section-header">
            <h2>üìö Full Library</h2>
            <span class="section-count" id="library-count">0 games</span>
        </div>
        <div id="library-grid" class="game-grid" style="display: none;"></div>
        <div class="load-more-container">
            <button class="load-more-btn" id="load-library-btn" onclick="toggleLibrary()">Load Full Library</button>
        </div>

        <div class="import-export">
            <h3>Data Management</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="exportData()">Export Library</button>
                <button onclick="document.getElementById('import-file').click()" class="secondary">Import Library</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>
    </div> <!-- End main-app -->

    <!-- Add/Edit Game Modal -->
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeGameModal()">√ó</button>
            <h2 id="modal-title" style="color: #fff; margin-bottom: 20px;">Add Game</h2>
            <form id="game-form" onsubmit="saveGame(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="game-title" required style="flex: 1;">
                        <button type="button" onclick="showSteamSearch()" class="secondary" style="padding: 8px 16px; white-space: nowrap;">üîç Search Steam</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cover Image</label>
                    <div class="image-upload-section">
                        <div class="image-preview" id="image-preview">üéÆ</div>
                        <div class="image-controls">
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                                <button type="button" onclick="fetchCoverArt()" style="flex: 1;">üîç Auto-Find Cover Art</button>
                                <button type="button" onclick="showCoverArtHelp()" class="secondary" style="padding: 8px 12px;" title="How to use">‚ùì</button>
                            </div>
                            <input type="url" id="game-cover" placeholder="Or paste image URL">
                            <input type="file" id="game-cover-upload" accept="image/*" onchange="handleImageUpload(event)">
                            <button type="button" class="secondary" onclick="clearImage()">Clear Image</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Platform *</label>
                    <select id="game-platform" required>
                        <option value="">Select platform...</option>
                        <option value="PC">PC</option>
                        <option value="PlayStation 5">PlayStation 5</option>
                        <option value="PlayStation 4">PlayStation 4</option>
                        <option value="Xbox Series X/S">Xbox Series X/S</option>
                        <option value="Xbox One">Xbox One</option>
                        <option value="Nintendo Switch">Nintendo Switch</option>
                        <option value="Steam Deck">Steam Deck</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Retro/Other">Retro/Other</option>
                    </select>
                </div>

                <div class="form-group" id="storefront-group" style="display: none;">
                    <label>PC Storefront</label>
                    <select id="game-storefront">
                        <option value="">Select storefront...</option>
                        <option value="Steam">Steam</option>
                        <option value="Epic Games">Epic Games</option>
                        <option value="GOG">GOG</option>
                        <option value="Xbox Game Pass">Xbox Game Pass</option>
                        <option value="EA App">EA App</option>
                        <option value="Ubisoft Connect">Ubisoft Connect</option>
                        <option value="Battle.net">Battle.net</option>
                        <option value="Itch.io">Itch.io</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="game-release-date">
                </div>

                <div class="form-group">
                    <label>Date Added to Library</label>
                    <input type="date" id="game-date-added">
                    <small style="color: #678; display: block; margin-top: 3px;">When you purchased or obtained this game</small>
                </div>

                <div class="form-group">
                    <label>Purchase Price ($)</label>
                    <input type="number" id="game-price" step="0.01" min="0" placeholder="59.99">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="game-free" style="width: auto; margin: 0;">
                        <span>Received for free</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Ownership</label>
                    <select id="game-ownership">
                        <option value="">Not yet owned</option>
                        <option value="owned">Owned</option>
                        <option value="subscription">Subscription (Game Pass, PS Plus, etc.)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Status *</label>
                    <select id="game-status" required>
                        <option value="wishlist">Wishlist</option>
                        <option value="backlog">Backlog</option>
                        <option value="on-deck">On Deck</option>
                        <option value="playing">Playing</option>
                        <option value="daily-driver">Daily Driver</option>
                        <option value="completed">Completed</option>
                        <option value="abandoned">Abandoned</option>
                    </select>
                </div>

                <div class="form-group" id="priority-group" style="display: none;">
                    <label>Backlog Priority</label>
                    <select id="game-priority">
                        <option value="">None</option>
                        <option value="high">üî¥ High Priority</option>
                        <option value="medium">üü° Medium Priority</option>
                        <option value="low">‚ö™ Low Priority</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Tags</label>
                    <div id="selected-tags" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; min-height: 32px; padding: 6px; background: #2c3440; border-radius: 4px;"></div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <input type="text" id="tag-input" placeholder="Add custom tag..." style="flex: 1;">
                        <button type="button" onclick="addCustomTag()" class="secondary">Add Tag</button>
                    </div>
                    <div id="tag-suggestions" style="max-height: 150px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: #1a1f29; border-radius: 4px;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Date Started</label>
                    <input type="date" id="game-started">
                </div>

                <div class="form-group">
                    <label>Date Finished/Put Down</label>
                    <input type="date" id="game-finished">
                </div>

                <div class="form-group">
                    <label>Rating</label>
                    <div class="star-rating" id="game-rating-input">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <input type="hidden" id="game-rating" value="0">
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="game-notes" placeholder="Your thoughts about this game..."></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save Game</button>
                    <button type="button" class="secondary" onclick="closeGameModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Game Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <button class="close-modal" onclick="closeDetailModal()">√ó</button>
            <div id="game-detail-content"></div>
        </div>
    </div>

    <!-- Add DLC Modal -->
    <div id="dlc-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeDlcModal()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">Add DLC</h2>
            <form id="dlc-form" onsubmit="saveDlc(event)">
                <div class="form-group">
                    <label>DLC Name *</label>
                    <input type="text" id="dlc-name" required>
                </div>
                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="dlc-release-date">
                </div>
                <div class="form-group">
                    <label>Purchase Price ($)</label>
                    <input type="number" id="dlc-price" step="0.01" min="0" placeholder="19.99">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="dlc-notes" placeholder="What's included in this DLC?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save DLC</button>
                    <button type="button" class="secondary" onclick="closeDlcModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Session Modal -->
    <div id="session-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessionModal()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">Log Play Session</h2>
            <form id="session-form" onsubmit="saveSession(event)">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="session-date" required>
                </div>
                <div class="form-group">
                    <label>Duration (hours)</label>
                    <input type="number" id="session-duration" step="0.5" min="0" placeholder="2.5">
                </div>
                <div class="form-group">
                    <label>Progress/Achievements</label>
                    <input type="text" id="session-progress" placeholder="Reached level 50, defeated final boss, etc.">
                </div>
                <div class="form-group">
                    <label>Session Notes</label>
                    <textarea id="session-notes" placeholder="What did you think about this session?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save Session</button>
                    <button type="button" class="secondary" onclick="closeSessionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upcoming Releases Modal -->
    <div id="upcoming-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-modal" onclick="closeUpcomingModal()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">üìÖ Upcoming Releases</h2>
            <div id="upcoming-content" style="color: #fff;"></div>
        </div>
    </div>

    <!-- Steam Import Modal -->
    <div id="steam-import-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" onclick="closeSteamImport()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">üéÆ Import from Steam</h2>
            
            <div id="steam-input-step">
                <div class="form-group">
                    <label>Steam Profile URL or Steam ID</label>
                    <input type="text" id="steam-input" placeholder="steamcommunity.com/id/yourname or 76561198012345678" style="width: 100%;">
                    <small style="color: #678; display: block; margin-top: 5px;">
                        Your Steam profile must be public. Find your Steam ID at <a href="https://steamid.io" target="_blank" style="color: #4a9eff;">steamid.io</a>
                    </small>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="fetchSteamLibrary()">Fetch Library</button>
                    <button class="secondary" onclick="closeSteamImport()">Cancel</button>
                </div>
            </div>
            
            <div id="steam-preview-step" style="display: none;">
                <div style="margin-bottom: 15px; color: #fff;">
                    <strong id="steam-count">0</strong> games found in Steam library
                </div>
                
                <div style="margin-bottom: 15px; padding: 15px; background: #2c3440; border-radius: 6px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="color: #9ab; display: block; margin-bottom: 5px; font-size: 0.85em;">Quick Filters:</label>
                            <label style="color: #fff; cursor: pointer; display: block; margin-bottom: 5px;">
                                <input type="checkbox" id="select-all-steam" onchange="toggleAllSteamGames()" style="margin-right: 5px;">
                                Select All
                            </label>
                        </div>
                        
                        <div>
                            <label style="color: #9ab; display: block; margin-bottom: 5px; font-size: 0.85em;">Last Played:</label>
                            <select id="last-played-filter" onchange="applySteamFilters()" style="width: 100%; padding: 5px; background: #1a1f29; color: #fff; border: 1px solid #3c4450; border-radius: 4px;">
                                <option value="all">All Time</option>
                                <option value="month">Last Month</option>
                                <option value="year">Last Year</option>
                                <option value="never">Never Played</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="color: #9ab; display: block; margin-bottom: 5px; font-size: 0.85em;">Playtime:</label>
                            <select id="playtime-filter" onchange="applySteamFilters()" style="width: 100%; padding: 5px; background: #1a1f29; color: #fff; border: 1px solid #3c4450; border-radius: 4px;">
                                <option value="all">Any Playtime</option>
                                <option value="over1">Over 1 hour</option>
                                <option value="over5">Over 5 hours</option>
                                <option value="over10">Over 10 hours</option>
                                <option value="over30">Over 30 hours</option>
                                <option value="over100">Over 100 hours</option>
                                <option value="none">0 hours (Unplayed)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="steam-games-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #2c3440; border-radius: 4px; padding: 10px; background: #1a1f29;">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="importSelectedSteamGames()">Import <span id="import-count">0</span> Games</button>
                    <button class="secondary" onclick="closeSteamImport()">Cancel</button>
                </div>
            </div>
            
            <div id="steam-loading" style="display: none; text-align: center; padding: 40px; color: #fff;">
                <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                <div>Loading Steam library...</div>
            </div>
        </div>
    </div>

    <!-- Steam Search Modal -->
    <div id="steam-search-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-modal" onclick="closeSteamSearch()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">üîç Search Steam Games</h2>
            
            <div class="form-group">
                <label>Search for a game</label>
                <input type="text" id="steam-search-input" placeholder="e.g., Elden Ring, Baldur's Gate, Hades..." style="width: 100%;" onkeyup="handleSteamSearchKeypress(event)">
                <small style="color: #678; display: block; margin-top: 5px;">
                    Or paste a Steam store URL (e.g., store.steampowered.com/app/1245620)
                </small>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="searchSteamGames()">Search</button>
                <button class="secondary" onclick="closeSteamSearch()">Cancel</button>
            </div>
            
            <div id="steam-search-results" style="display: none;">
                <div style="margin-bottom: 10px; color: #9ab;">
                    <strong id="steam-search-count">0</strong> results found
                </div>
                <div id="steam-search-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #2c3440; border-radius: 4px; padding: 10px; background: #1a1f29;">
                </div>
            </div>
            
            <div id="steam-search-loading" style="display: none; text-align: center; padding: 40px; color: #fff;">
                <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                <div>Searching Steam...</div>
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = "1.0";
        
        // REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://lryzoqxeoflsyzaphzqh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyeXpvcXhlb2Zsc3l6YXBoenFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTM0MzEsImV4cCI6MjA4NDE4OTQzMX0.9SeOZZCWkcvLmTrt58j58I83UN5yrcetufTQKxMUG9g';
        
        // OPTIONAL: Add your Steam Web API Key here for Steam import feature
        // Get one free at: https://steamcommunity.com/dev/apikey
        const STEAM_API_KEY = '6A9D9D4DCE1906F5D4CA04272E42E867';
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let games = [];
        let currentGameId = null;
        let currentEditGameId = null;
        let currentEditSessionId = null;
        let currentImageData = null;
        let currentUser = null;
        let isSyncing = false;
        
        // Steam search cache
        let steamGamesCache = [];
        let steamAppListCache = null;
        
        // Default tag suggestions
        const defaultTags = [
            'Action', 'RPG', 'Strategy', 'Puzzle', 'Platformer', 'Shooter',
            'Souls-like', 'Roguelike', 'Metroidvania', 'Turn-Based',
            'Co-op', 'Multiplayer', 'Single-player', 'Local Co-op',
            'Story-Rich', 'Open World', 'Sandbox', 'Survival',
            'Horror', 'Cozy', 'Relaxing', 'Challenging',
            'Short (<10h)', 'Long (50h+)', 'Endless'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showMainApp(true); // true = logged in
                await loadData();
                populateCompletedYearFilter();
                renderGames();
                updateStats();
            } else {
                // Start in offline mode by default
                showMainApp(false); // false = offline mode
                loadDataOffline();
                populateCompletedYearFilter();
                renderGames();
                updateStats();
            }
            
            setupRatingInput();
            setupPlatformWatcher();
            loadSortPreference();
            initializeTagSuggestions();
            updateTagFilter();
            
            // Setup status change listener for priority field
            document.getElementById('game-status').addEventListener('change', togglePriorityField);
            
            // Initialize mobile filters (collapsed on mobile)
            if (window.innerWidth <= 768) {
                document.getElementById('filter-controls').classList.add('collapsed');
            }
            
            // Show/hide Steam import button based on API key
            if (STEAM_API_KEY) {
                document.getElementById('steam-import-btn').style.display = 'inline-block';
            } else {
                document.getElementById('steam-import-btn').style.display = 'none';
            }
            
            // Request notification permission and check releases
            requestNotificationPermission();
            checkUpcomingReleases();
            
            // Check daily for new releases
            setInterval(checkUpcomingReleases, 24 * 60 * 60 * 1000);
            
            // Set today's date as default for session
            document.getElementById('session-date').valueAsDate = new Date();

            // Watch for image URL changes
            document.getElementById('game-cover').addEventListener('input', function() {
                updateImagePreview(this.value);
            });

            // Listen for auth state changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    showMainApp(true); // Logged in
                    loadData().then(() => {
                        populateCompletedYearFilter();
                        renderGames();
                        updateStats();
                    });
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showMainApp(false); // Switch to offline mode
                    loadDataOffline();
                    populateCompletedYearFilter();
                    renderGames();
                    updateStats();
                }
            });
        });

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        function showMainApp(isLoggedIn) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            if (isLoggedIn && currentUser) {
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('sync-status').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('login-btn').style.display = 'none';
            } else {
                document.getElementById('user-email').textContent = 'Offline Mode';
                document.getElementById('sync-status').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('login-btn').style.display = 'inline-block';
            }
        }

        function showLoginModal() {
            document.getElementById('auth-container').style.display = 'block';
        }

        function loadDataOffline() {
            const stored = localStorage.getItem('gameLibrary');
            if (stored) {
                const data = JSON.parse(stored);
                games = Array.isArray(data) ? data.map(migrateGameData) : 
                        data.games ? data.games.map(migrateGameData) : [];
            } else {
                games = [];
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
            
            document.getElementById('auth-error').textContent = '';
            document.getElementById('auth-error-signup').textContent = '';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                document.getElementById('auth-error').textContent = error.message;
            } else {
                // Success - auth state change will handle the rest
                document.getElementById('auth-container').style.display = 'none';
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password
            });
            
            if (error) {
                document.getElementById('auth-error-signup').textContent = error.message;
            } else {
                alert('Check your email for the confirmation link!');
                switchAuthTab('login');
            }
        }

        function skipLogin() {
            document.getElementById('auth-container').style.display = 'none';
            showMainApp(false); // Offline mode
            loadDataOffline();
            populateCompletedYearFilter();
            renderGames();
            updateStats();
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            // Auth state change will handle switching to offline mode
        }

        function setSyncStatus(status) {
            const statusEl = document.getElementById('sync-status');
            statusEl.className = 'sync-status ' + status;
            statusEl.textContent = status === 'syncing' ? 'Syncing...' : 
                                   status === 'synced' ? 'Synced' : 
                                   'Sync Error';
        }

        function setupPlatformWatcher() {
            const platformSelect = document.getElementById('game-platform');
            platformSelect.addEventListener('change', function() {
                const pcSelected = this.value === 'PC';
                document.getElementById('storefront-group').style.display = pcSelected ? 'block' : 'none';
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                updateImagePreview(currentImageData);
                document.getElementById('game-cover').value = '';
            };
            reader.readAsDataURL(file);
        }

        function updateImagePreview(src) {
            const preview = document.getElementById('image-preview');
            if (src) {
                preview.innerHTML = `<img src="${src}" alt="Preview">`;
            } else {
                preview.innerHTML = 'üéÆ';
            }
        }

        function clearImage() {
            currentImageData = null;
            document.getElementById('game-cover').value = '';
            document.getElementById('game-cover-upload').value = '';
            updateImagePreview(null);
        }

        function setupRatingInput() {
            const stars = document.querySelectorAll('#game-rating-input .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    const currentRating = parseInt(document.getElementById('game-rating').value);
                    
                    // If clicking the same rating, clear it (set to 0)
                    if (rating === currentRating) {
                        document.getElementById('game-rating').value = 0;
                        updateStarDisplay(0);
                    } else {
                        document.getElementById('game-rating').value = rating;
                        updateStarDisplay(rating);
                    }
                });
            });
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#game-rating-input .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                setSyncStatus('syncing');
                
                // Load from Supabase
                const { data, error } = await supabaseClient
                    .from('games')
                    .select('data')
                    .eq('user_id', currentUser.id)
                    .single();
                
                // Also load from localStorage
                const stored = localStorage.getItem('gameLibrary');
                let localGames = [];
                if (stored) {
                    const localData = JSON.parse(stored);
                    localGames = Array.isArray(localData) ? localData.map(migrateGameData) : 
                            localData.games ? localData.games.map(migrateGameData) : [];
                }
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                    console.error('Error loading data:', error);
                    setSyncStatus('error');
                    
                    // Fall back to localStorage
                    games = localGames;
                } else if (data) {
                    // Supabase has data - merge with localStorage
                    const parsed = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                    const cloudGames = Array.isArray(parsed) ? parsed.map(migrateGameData) : 
                            parsed.games ? parsed.games.map(migrateGameData) : [];
                    
                    // Merge: combine cloud + local, removing duplicates by title
                    games = mergeGames(cloudGames, localGames);
                    
                    // If we merged new games from localStorage, save back to cloud
                    if (games.length > cloudGames.length) {
                        console.log(`Merged ${games.length - cloudGames.length} games from localStorage into cloud`);
                        await saveData(); // Sync merged data to cloud
                    }
                    
                    setSyncStatus('synced');
                } else {
                    // No data in Supabase yet - use localStorage and sync to cloud
                    console.log('First login - migrating localStorage to cloud');
                    games = localGames;
                    if (games.length > 0) {
                        await saveData(); // Sync to cloud
                    } else {
                        setSyncStatus('synced');
                    }
                }
            } catch (err) {
                console.error('Load error:', err);
                setSyncStatus('error');
            }
        }

        function mergeGames(cloudGames, localGames) {
            // Create a map of cloud games by ID
            const gamesMap = new Map();
            cloudGames.forEach(game => gamesMap.set(game.id, game));
            
            // Add local games that don't exist in cloud (by ID)
            localGames.forEach(localGame => {
                if (!gamesMap.has(localGame.id)) {
                    console.log(`Adding local game to merged library: ${localGame.title}`);
                    gamesMap.set(localGame.id, localGame);
                }
            });
            
            return Array.from(gamesMap.values());
        }

        function migrateGameData(game) {
            // Migrate old storefronts array to single storefront
            if (game.storefronts && Array.isArray(game.storefronts)) {
                game.storefront = game.storefronts[0] || '';
                delete game.storefronts;
            }
            
            // Migrate old platforms array to single platform
            let platform = game.platform;
            if (!platform && game.platforms && Array.isArray(game.platforms)) {
                platform = game.platforms[0] || '';
            }
            
            return {
                id: game.id || Date.now().toString(),
                title: game.title || 'Untitled',
                platform: platform || '',
                storefront: game.storefront || '',
                releaseDate: game.releaseDate || '',
                dateAddedToLibrary: game.dateAddedToLibrary || '',
                price: game.price || '',
                free: game.free || false,
                ownership: game.ownership || '',
                status: game.status || 'backlog',
                priority: game.priority || '',
                tags: game.tags || [],
                dateStarted: game.dateStarted || '',
                dateFinished: game.dateFinished || '',
                rating: game.rating || 0,
                notes: game.notes || '',
                cover: game.cover || '',
                addedDate: game.addedDate || new Date().toISOString(),
                sessions: game.sessions || [],
                dlcs: game.dlcs || []
            };
        }

        async function saveData() {
            const data = {
                version: APP_VERSION,
                games: games
            };
            
            // Always save to localStorage (works offline and as backup)
            localStorage.setItem('gameLibrary', JSON.stringify(data));
            
            // If logged in, also sync to Supabase
            if (!currentUser) {
                console.log('saveData: Offline mode - saved to localStorage only');
                return;
            }
            
            if (isSyncing) {
                console.log('saveData: Already syncing, skipping');
                return;
            }
            isSyncing = true;
            
            try {
                setSyncStatus('syncing');
                
                console.log('saveData: Attempting to save', games.length, 'games to Supabase');
                console.log('saveData: User ID:', currentUser.id);
                
                // Save to Supabase
                const { error } = await supabaseClient
                    .from('games')
                    .upsert({
                        id: currentUser.id, // Use user ID as primary key
                        user_id: currentUser.id,
                        data: data,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('Supabase save error:', error);
                    console.error('Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    setSyncStatus('error');
                } else {
                    console.log('saveData: Successfully saved to Supabase');
                    console.log('saveData: First game platform:', games[0]?.platform);
                    console.log('saveData: First game platforms?:', games[0]?.platforms);
                    setSyncStatus('synced');
                }
                
            } catch (err) {
                console.error('Save error (catch block):', err);
                setSyncStatus('error');
            } finally {
                isSyncing = false;
            }
        }

        let completedYearFilter = new Date().getFullYear().toString();
        let libraryLoaded = false;

        function renderGames() {
            const filtered = getFilteredGames();
            
            // Separate games by status
            const playing = filtered.filter(g => g.status === 'playing');
            const dailyDriver = filtered.filter(g => g.status === 'daily-driver');
            const onDeck = filtered.filter(g => g.status === 'on-deck');
            const completed = filtered.filter(g => g.status === 'completed');
            const library = filtered; // Show ALL games in library
            
            // Filter completed by selected year
            const completedFiltered = completedYearFilter === 'all' ? completed : completed.filter(g => {
                if (!g.dateFinished) return false;
                return new Date(g.dateFinished).getFullYear() === parseInt(completedYearFilter);
            });
            
            // Render each section
            renderSection('playing-grid', playing, 'playing-count');
            renderSection('daily-driver-grid', dailyDriver, 'daily-driver-count');
            renderSection('ondeck-grid', onDeck, 'ondeck-count');
            renderCompletedSection(completedFiltered, completed.length);
            
            // Update library count but don't render unless loaded
            document.getElementById('library-count').textContent = `${library.length} games`;
            if (libraryLoaded) {
                renderSection('library-grid', library, 'library-count');
            }
        }

        function renderSection(gridId, gamesArray, countId) {
            const grid = document.getElementById(gridId);
            
            if (gamesArray.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p style="color: #678;">No games in this section</p>
                    </div>
                `;
                if (countId) {
                    document.getElementById(countId).textContent = '0 games';
                }
                return;
            }

            grid.innerHTML = gamesArray.map(game => createGameCard(game)).join('');
            
            if (countId) {
                document.getElementById(countId).textContent = `${gamesArray.length} game${gamesArray.length !== 1 ? 's' : ''}`;
            }
        }

        function renderCompletedSection(gamesArray, totalCompleted) {
            const grid = document.getElementById('completed-grid');
            
            if (gamesArray.length === 0) {
                const yearText = completedYearFilter === 'all' ? '' : 'in ' + completedYearFilter;
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p style="color: #678;">No completed games ${yearText}</p>
                    </div>
                `;
                document.getElementById('completed-count').textContent = completedYearFilter === 'all' ? '0 total' : '0 in ' + completedYearFilter;
                return;
            }

            grid.innerHTML = gamesArray.map(game => createGameCard(game)).join('');
            
            const countText = completedYearFilter === 'all' 
                ? `${gamesArray.length} total` 
                : `${gamesArray.length} in ${completedYearFilter}`;
            document.getElementById('completed-count').textContent = countText;
        }

        function createGameCard(game) {
            const playtime = getTotalPlaytime(game);
            return `
                <div class="game-card" onclick="showGameDetail('${game.id}')">
                    <div class="game-cover">
                        ${game.cover ? `<img src="${game.cover}" alt="${game.title}">` : 'üéÆ'}
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                        ${game.tags && game.tags.length > 0 ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; margin-bottom: 6px;">
                                ${game.tags.slice(0, 3).map(tag => `
                                    <span style="padding: 2px 8px; background: #4a9eff; color: #fff; border-radius: 10px; font-size: 0.7em;">
                                        ${tag}
                                    </span>
                                `).join('')}
                                ${game.tags.length > 3 ? `<span style="color: #9ab; font-size: 0.7em;">+${game.tags.length - 3}</span>` : ''}
                            </div>
                        ` : ''}
                        <div class="game-meta">
                            <div class="game-meta-left">
                                <span class="status-badge status-${game.status}">${game.status}</span>
                                ${game.status === 'backlog' && game.priority ? `
                                    <span class="status-badge" style="background: ${
                                        game.priority === 'high' ? '#ff6b6b' : 
                                        game.priority === 'medium' ? '#ffd43b' : '#9ab'
                                    }; color: ${game.priority === 'medium' ? '#000' : '#fff'};">
                                        ${game.priority === 'high' ? 'üî¥' : game.priority === 'medium' ? 'üü°' : '‚ö™'} 
                                        ${game.priority.charAt(0).toUpperCase() + game.priority.slice(1)}
                                    </span>
                                ` : ''}
                                ${playtime > 0 ? `<span class="game-playtime">‚è±Ô∏è ${playtime.toFixed(1)}h</span>` : ''}
                            </div>
                            ${game.rating > 0 ? `<span class="rating">${'‚òÖ'.repeat(game.rating)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleLibrary() {
            libraryLoaded = !libraryLoaded;
            const grid = document.getElementById('library-grid');
            const btn = document.getElementById('load-library-btn');
            
            if (libraryLoaded) {
                grid.style.display = 'grid';
                btn.textContent = 'Hide Full Library';
                renderGames(); // Re-render to populate library
            } else {
                grid.style.display = 'none';
                btn.textContent = 'Load Full Library';
            }
        }

        function getFilteredGames() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            const tagFilter = document.getElementById('tag-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const sort = document.getElementById('sort-select').value;

            let filtered = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(search) ||
                                    (game.platform && game.platform.toLowerCase().includes(search));
                const matchesStatus = status === 'all' || game.status === status;
                
                // Tag filter
                const matchesTag = tagFilter === 'all' || (game.tags && game.tags.includes(tagFilter));
                
                // Priority filter
                let matchesPriority = true;
                if (priorityFilter !== 'all') {
                    if (priorityFilter === 'none') {
                        matchesPriority = !game.priority || game.priority === '';
                    } else {
                        matchesPriority = game.priority === priorityFilter;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesTag && matchesPriority;
            });

            switch(sort) {
                case 'title':
                    filtered.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'recent':
                    filtered.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate));
                    break;
                case 'recently-played':
                    filtered.sort((a, b) => {
                        const aLastPlayed = getLastPlayedDate(a);
                        const bLastPlayed = getLastPlayedDate(b);
                        // Games never played go to the end
                        if (!aLastPlayed && !bLastPlayed) return 0;
                        if (!aLastPlayed) return 1;
                        if (!bLastPlayed) return -1;
                        return new Date(bLastPlayed) - new Date(aLastPlayed);
                    });
                    break;
                case 'rating':
                    filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'playtime':
                    filtered.sort((a, b) => getTotalPlaytime(b) - getTotalPlaytime(a));
                    break;
                case 'priority':
                    const priorityOrder = { high: 1, medium: 2, low: 3 };
                    filtered.sort((a, b) => {
                        const aPriority = a.priority ? priorityOrder[a.priority] : 999;
                        const bPriority = b.priority ? priorityOrder[b.priority] : 999;
                        return aPriority - bPriority;
                    });
                    break;
            }

            return filtered;
        }

        function getLastPlayedDate(game) {
            if (!game.sessions || game.sessions.length === 0) return null;
            // Find the most recent session date
            const sortedSessions = [...game.sessions].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            return sortedSessions[0].date;
        }

        function getTotalPlaytime(game) {
            if (!game.sessions) return 0;
            return game.sessions.reduce((sum, session) => sum + (parseFloat(session.duration) || 0), 0);
        }

        function getTotalPrice(game) {
            let total = parseFloat(game.price) || 0;
            if (game.dlcs) {
                total += game.dlcs.reduce((sum, dlc) => sum + (parseFloat(dlc.price) || 0), 0);
            }
            return total;
        }

        function toggleFilters() {
            const filterControls = document.getElementById('filter-controls');
            const toggleBtn = document.getElementById('filter-toggle-btn');
            
            if (filterControls.classList.contains('collapsed')) {
                filterControls.classList.remove('collapsed');
                toggleBtn.textContent = 'üîç Hide Filters';
            } else {
                filterControls.classList.add('collapsed');
                toggleBtn.textContent = 'üîç Show Filters';
            }
        }

        function filterGames() {
            renderGames();
        }

        function handleSortChange() {
            const sortValue = document.getElementById('sort-select').value;
            localStorage.setItem('preferredSort', sortValue);
            filterGames();
        }

        function loadSortPreference() {
            const savedSort = localStorage.getItem('preferredSort');
            if (savedSort) {
                document.getElementById('sort-select').value = savedSort;
            }
        }

        function updateStats() {
            const yearFilter = document.getElementById('stats-year-filter').value;
            
            let gamesPlayedCount = 0;
            let totalSessions = 0;
            let totalHours = 0;
            let totalSpent = 0;
            
            if (yearFilter === 'all') {
                // All time stats
                games.forEach(game => {
                    if (game.sessions && game.sessions.length > 0) {
                        gamesPlayedCount++;
                        totalSessions += game.sessions.length;
                        totalHours += getTotalPlaytime(game);
                    }
                    totalSpent += getTotalPrice(game);
                });
            } else {
                // Specific year stats
                const year = parseInt(yearFilter);
                const gamesPlayedThisYear = new Set();
                
                // Sessions, Hours, and track which games were played
                games.forEach(game => {
                    if (game.sessions) {
                        game.sessions.forEach(session => {
                            if (session.date) {
                                const sessionYear = new Date(session.date).getFullYear();
                                if (sessionYear === year) {
                                    gamesPlayedThisYear.add(game.id);
                                    totalSessions++;
                                    totalHours += parseFloat(session.duration) || 0;
                                }
                            }
                        });
                    }
                });
                
                gamesPlayedCount = gamesPlayedThisYear.size;
                
                // Spent: sum of games added in that year
                games.forEach(game => {
                    if (game.dateAddedToLibrary) {
                        const addedYear = new Date(game.dateAddedToLibrary).getFullYear();
                        if (addedYear === year) {
                            totalSpent += getTotalPrice(game);
                        }
                    }
                });
            }
            
            document.getElementById('total-games').textContent = gamesPlayedCount;
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('total-spent').textContent = '$' + totalSpent.toFixed(2);
        }

        function updateStatsFilter() {
            updateStats();
        }

        function populateCompletedYearFilter() {
            const completedGames = games.filter(g => g.status === 'completed' && g.dateFinished);
            const years = new Set();
            
            completedGames.forEach(game => {
                const year = new Date(game.dateFinished).getFullYear();
                years.add(year);
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a); // Newest first
            const select = document.getElementById('completed-year-filter');
            
            // Keep "All Years" option and add individual years
            select.innerHTML = '<option value="all">All Years</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === new Date().getFullYear()) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Set the current filter value
            const currentYear = new Date().getFullYear();
            if (sortedYears.includes(currentYear)) {
                completedYearFilter = currentYear.toString();
                select.value = currentYear.toString();
            } else {
                completedYearFilter = 'all';
                select.value = 'all';
            }
        }

        function filterCompletedYear() {
            completedYearFilter = document.getElementById('completed-year-filter').value;
            renderGames();
        }

        function getSelectedCheckboxValues(selector) {
            const checkboxes = document.querySelectorAll(selector + ':checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function setCheckboxValues(selector, values) {
            document.querySelectorAll(selector).forEach(cb => {
                cb.checked = values && values.includes(cb.value);
            });
        }

        function showAddGameModal() {
            currentEditGameId = null;
            currentImageData = null;
            currentGameTags = [];
            document.getElementById('modal-title').textContent = 'Add Game';
            document.getElementById('game-form').reset();
            updateStarDisplay(0);
            updateImagePreview(null);
            updateSelectedTagsDisplay();
            updateTagSuggestionsDisplay();
            document.getElementById('storefront-group').style.display = 'none';
            document.getElementById('priority-group').style.display = 'none';
            document.getElementById('game-modal').classList.add('active');
        }

        function closeGameModal() {
            document.getElementById('game-modal').classList.remove('active');
            currentGameTags = [];
        }

        async function saveGame(event) {
            event.preventDefault();
            
            try {
                const platform = document.getElementById('game-platform').value;
                const storefront = document.getElementById('game-storefront').value;

                console.log('Saving platform:', platform);

                if (!platform) {
                    alert('Please select a platform');
                    return;
                }

                const gameData = {
                    title: document.getElementById('game-title').value,
                    platform: platform,
                    storefront: platform === 'PC' ? storefront : '',
                    releaseDate: document.getElementById('game-release-date').value,
                    dateAddedToLibrary: document.getElementById('game-date-added').value,
                    price: document.getElementById('game-price').value,
                    free: document.getElementById('game-free').checked,
                    ownership: document.getElementById('game-ownership').value,
                    status: document.getElementById('game-status').value,
                    priority: document.getElementById('game-priority').value,
                    tags: currentGameTags.slice(), // Copy the array
                    dateStarted: document.getElementById('game-started').value,
                    dateFinished: document.getElementById('game-finished').value,
                    rating: parseInt(document.getElementById('game-rating').value),
                    notes: document.getElementById('game-notes').value,
                    cover: currentImageData || document.getElementById('game-cover').value,
                };

                console.log('GameData being saved:', gameData);

                if (currentEditGameId) {
                    const index = games.findIndex(g => g.id === currentEditGameId);
                    const oldGame = games[index];
                    
                    // Remove old 'platforms' field if it exists
                    const { platforms, ...gameWithoutPlatforms } = oldGame;
                    
                    games[index] = { ...gameWithoutPlatforms, ...gameData };
                    console.log('Updated game:', games[index]);
                    console.log('Updated game platform field:', games[index].platform);
                    console.log('Updated game has platforms field?:', games[index].platforms);
                } else {
                    const newGame = {
                        ...gameData,
                        id: Date.now().toString(),
                        addedDate: new Date().toISOString(),
                        sessions: [],
                        dlcs: []
                    };
                    games.push(newGame);
                    console.log('New game added:', newGame);
                }

                console.log('About to save data...');
                await saveData();
                console.log('Data saved successfully');
                
                populateCompletedYearFilter(); // Update year dropdown
                checkUpcomingReleases(); // Update notification badge
                updateTagFilter(); // Update tag filter dropdown
                renderGames();
                updateStats();
                closeGameModal();
            } catch (error) {
                console.error('Error in saveGame:', error);
                alert('Error saving game: ' + error.message);
            }
        }

        function showGameDetail(gameId) {
            currentGameId = gameId;
            const game = games.find(g => g.id === gameId);
            if (!game) return;

            const totalPlaytime = getTotalPlaytime(game);
            const sessionCount = game.sessions ? game.sessions.length : 0;
            const totalPrice = getTotalPrice(game);
            const dlcCount = game.dlcs ? game.dlcs.length : 0;

            const content = `
                <div class="game-detail-header">
                    <div class="game-detail-cover">
                        ${game.cover ? `<img src="${game.cover}" alt="${game.title}">` : 'üéÆ'}
                    </div>
                    <div class="game-detail-info">
                        <h2>${game.title}</h2>
                        ${game.rating > 0 ? `<div class="rating" style="font-size: 1.5em; margin-bottom: 10px;">${'‚òÖ'.repeat(game.rating)}</div>` : ''}
                        <div class="game-detail-meta">
                            <div class="meta-item">
                                <div class="meta-label">Status</div>
                                <div class="meta-value"><span class="status-badge status-${game.status}">${game.status}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Platform</div>
                                <div class="meta-value">${game.platform || 'N/A'}</div>
                            </div>
                            ${game.storefront ? `
                            <div class="meta-item">
                                <div class="meta-label">Storefront</div>
                                <div class="meta-value">${game.storefront}</div>
                            </div>` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Ownership</div>
                                <div class="meta-value">${game.ownership === 'subscription' ? 'Subscription' : game.ownership === 'owned' ? 'Owned' : 'Not owned yet'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Release Date</div>
                                <div class="meta-value">${game.releaseDate ? new Date(game.releaseDate).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Purchase Price</div>
                                <div class="meta-value">${game.free ? 'Free' : game.price ? '$' + parseFloat(game.price).toFixed(2) : 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Total Cost (incl. DLC)</div>
                                <div class="meta-value">${game.free ? 'Free' : '$' + totalPrice.toFixed(2)}</div>
                            </div>
                            ${game.dateStarted ? `
                            <div class="meta-item">
                                <div class="meta-label">Started</div>
                                <div class="meta-value">${new Date(game.dateStarted).toLocaleDateString()}</div>
                            </div>` : ''}
                            ${game.dateFinished ? `
                            <div class="meta-item">
                                <div class="meta-label">Finished</div>
                                <div class="meta-value">${new Date(game.dateFinished).toLocaleDateString()}</div>
                            </div>` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Total Playtime</div>
                                <div class="meta-value">${totalPlaytime.toFixed(1)} hours</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Sessions Logged</div>
                                <div class="meta-value">${sessionCount}</div>
                            </div>
                        </div>
                        ${game.notes ? `<div class="meta-item" style="margin-top: 15px;"><div class="meta-label">Notes</div><div class="meta-value">${game.notes}</div></div>` : ''}
                        <div class="action-buttons">
                            <button onclick="showAddSessionModal()">+ Log Session</button>
                            <button onclick="showAddDlcModal()" class="secondary">+ Add DLC</button>
                            <button onclick="editGame('${game.id}')" class="secondary">Edit Game</button>
                            <button onclick="deleteGame('${game.id}')" class="delete-btn">Delete</button>
                        </div>
                    </div>
                </div>

                <div class="sessions-section">
                    <h3>DLC & Expansions (${dlcCount})</h3>
                    ${game.dlcs && game.dlcs.length > 0 ? `
                        <div class="dlc-list">
                            ${game.dlcs.map(dlc => `
                                <div class="dlc-item">
                                    <div class="dlc-info">
                                        <div class="dlc-name">${dlc.name}</div>
                                        <div class="dlc-meta">
                                            ${dlc.releaseDate ? `Released: ${new Date(dlc.releaseDate).toLocaleDateString()}` : ''}
                                            ${dlc.price ? ` ‚Ä¢ $${parseFloat(dlc.price).toFixed(2)}` : ''}
                                        </div>
                                        ${dlc.notes ? `<div class="dlc-meta" style="margin-top: 5px;">${dlc.notes}</div>` : ''}
                                    </div>
                                    <button class="dlc-delete" onclick="deleteDlc('${dlc.id}')">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #678;">No DLC added yet.</p>'}
                </div>
                
                <div class="sessions-section">
                    <h3>Play Sessions (${sessionCount})</h3>
                    ${game.sessions && game.sessions.length > 0 ? `
                        <div class="session-list">
                            ${[...game.sessions].sort((a, b) => {
                                // Sort by date, most recent first
                                const dateA = new Date(a.date);
                                const dateB = new Date(b.date);
                                return dateB - dateA;
                            }).map(session => {
                                // Fix timezone issue by parsing date without time component
                                const dateParts = session.date.split('-');
                                const displayDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                return `
                                <div class="session-card">
                                    <div class="session-header">
                                        <span class="session-date">${displayDate.toLocaleDateString()}</span>
                                        <div style="display: flex; gap: 5px; align-items: center;">
                                            <span class="session-duration">${session.duration ? `${session.duration}h` : ''}</span>
                                            <button onclick="editSession('${session.id}')" class="session-edit-btn" title="Edit">‚úèÔ∏è</button>
                                            <button onclick="deleteSession('${session.id}')" class="session-delete-btn" title="Delete">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    ${session.notes ? `<div class="session-notes">${session.notes}</div>` : ''}
                                    ${session.progress ? `<div class="session-progress">üìä ${session.progress}</div>` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<p style="color: #678;">No sessions logged yet. Start tracking your playtime!</p>'}
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="closeDetailModal()" class="secondary" style="width: 100%; max-width: 300px; padding: 15px;">
                        ‚Üê Back to Library
                    </button>
                </div>
            `;

            document.getElementById('game-detail-content').innerHTML = content;
            document.getElementById('detail-modal').classList.add('active');
            
            // Reset scroll position to top - the .modal element has the scroll
            setTimeout(() => {
                const modal = document.getElementById('detail-modal');
                if (modal) {
                    modal.scrollTop = 0;
                }
            }, 0);
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
            currentGameId = null;
        }

        function editGame(gameId) {
            closeDetailModal();
            const game = games.find(g => g.id === gameId);
            if (!game) return;

            currentEditGameId = gameId;
            currentImageData = null;
            document.getElementById('modal-title').textContent = 'Edit Game';
            document.getElementById('game-title').value = game.title;
            
            // Handle migration from old platforms array to single platform
            const platform = Array.isArray(game.platform) ? game.platform[0] : game.platform;
            document.getElementById('game-platform').value = platform || '';
            document.getElementById('game-storefront').value = game.storefront || '';
            
            const pcSelected = platform === 'PC';
            document.getElementById('storefront-group').style.display = pcSelected ? 'block' : 'none';
            
            document.getElementById('game-release-date').value = game.releaseDate || '';
            document.getElementById('game-date-added').value = game.dateAddedToLibrary || '';
            document.getElementById('game-price').value = game.price || '';
            document.getElementById('game-free').checked = game.free || false;
            document.getElementById('game-ownership').value = game.ownership || '';
            document.getElementById('game-status').value = game.status;
            
            // Load priority
            document.getElementById('game-priority').value = game.priority || '';
            togglePriorityField();
            
            // Load tags
            currentGameTags = game.tags ? game.tags.slice() : [];
            updateSelectedTagsDisplay();
            updateTagSuggestionsDisplay();
            
            document.getElementById('game-started').value = game.dateStarted || '';
            document.getElementById('game-finished').value = game.dateFinished || '';
            document.getElementById('game-rating').value = game.rating || 0;
            document.getElementById('game-notes').value = game.notes || '';
            
            if (game.cover) {
                updateImagePreview(game.cover);
                currentImageData = game.cover;
            }
            
            updateStarDisplay(game.rating || 0);
            
            document.getElementById('game-modal').classList.add('active');
        }

        async function deleteGame(gameId) {
            if (!confirm('Are you sure you want to delete this game and all its sessions?')) return;
            
            games = games.filter(g => g.id !== gameId);
            await saveData();
            renderGames();
            updateStats();
            closeDetailModal();
        }

        function showAddDlcModal() {
            document.getElementById('dlc-form').reset();
            document.getElementById('dlc-modal').classList.add('active');
        }

        function closeDlcModal() {
            document.getElementById('dlc-modal').classList.remove('active');
        }

        async function saveDlc(event) {
            event.preventDefault();
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            if (!game.dlcs) game.dlcs = [];

            const dlc = {
                id: Date.now().toString(),
                name: document.getElementById('dlc-name').value,
                releaseDate: document.getElementById('dlc-release-date').value,
                price: document.getElementById('dlc-price').value,
                notes: document.getElementById('dlc-notes').value
            };

            game.dlcs.push(dlc);
            await saveData();
            updateStats();
            closeDlcModal();
            showGameDetail(currentGameId);
        }

        async function deleteDlc(dlcId) {
            if (!confirm('Are you sure you want to delete this DLC?')) return;
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            game.dlcs = game.dlcs.filter(d => d.id !== dlcId);
            await saveData();
            updateStats();
            showGameDetail(currentGameId);
        }

        function showAddSessionModal() {
            currentEditSessionId = null; // Clear edit mode
            document.getElementById('session-form').reset();
            document.getElementById('session-date').valueAsDate = new Date();
            document.getElementById('session-modal').classList.add('active');
        }

        function closeSessionModal() {
            currentEditSessionId = null; // Clear edit mode on close
            document.getElementById('session-modal').classList.remove('active');
        }

        function showUpcomingReleases() {
            const wishlistGames = games.filter(g => g.status === 'wishlist' && g.releaseDate);
            
            if (wishlistGames.length === 0) {
                document.getElementById('upcoming-content').innerHTML = `
                    <p style="color: #678; text-align: center; padding: 40px;">
                        No wishlisted games with release dates. Add games to your wishlist and set their release dates to see them here!
                    </p>
                `;
                document.getElementById('upcoming-modal').classList.add('active');
                return;
            }
            
            // Sort by release date (soonest first)
            wishlistGames.sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingHtml = wishlistGames.map(game => {
                const releaseDate = new Date(game.releaseDate);
                const daysUntil = Math.ceil((releaseDate - today) / (1000 * 60 * 60 * 24));
                const isPast = daysUntil < 0;
                const isToday = daysUntil === 0;
                
                let dateStatus = '';
                if (isPast) {
                    dateStatus = `<span style="color: #ff6b6b;">Released ${Math.abs(daysUntil)} days ago</span>`;
                } else if (isToday) {
                    dateStatus = `<span style="color: #00c030; font-weight: bold;">OUT TODAY!</span>`;
                } else if (daysUntil <= 7) {
                    dateStatus = `<span style="color: #ffd93d; font-weight: bold;">In ${daysUntil} days</span>`;
                } else if (daysUntil <= 30) {
                    dateStatus = `<span style="color: #9ab;">In ${daysUntil} days</span>`;
                } else {
                    dateStatus = `<span style="color: #678;">In ${Math.floor(daysUntil / 30)} months</span>`;
                }
                
                return `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #1a1f29; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="showGameDetail('${game.id}')">
                        <div style="width: 80px; height: 110px; flex-shrink: 0; background: #2c3440; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${game.cover ? `<img src="${game.cover}" alt="${game.title}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 40px;">üéÆ</span>'}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 8px 0; color: #fff;">${game.title}</h3>
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <span style="color: #9ab;"><strong>${releaseDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</strong></span>
                                ${dateStatus}
                                ${game.platform ? `<span style="color: #678;">‚Ä¢ ${game.platform}</span>` : ''}
                                ${game.price ? `<span style="color: #678;">‚Ä¢ $${parseFloat(game.price).toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('upcoming-content').innerHTML = upcomingHtml;
            document.getElementById('upcoming-modal').classList.add('active');
        }

        function closeUpcomingModal() {
            document.getElementById('upcoming-modal').classList.remove('active');
        }

        // Notification system
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function checkUpcomingReleases() {
            const wishlistGames = games.filter(g => g.status === 'wishlist' && g.releaseDate);
            if (wishlistGames.length === 0) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            let upcomingCount = 0;
            let releasingToday = [];

            wishlistGames.forEach(game => {
                const releaseDate = new Date(game.releaseDate);
                releaseDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((releaseDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil >= 0 && daysUntil <= 7) {
                    upcomingCount++;
                }

                if (daysUntil === 0) {
                    releasingToday.push(game);
                }
            });

            // Update notification badge
            const badge = document.getElementById('notification-badge');
            const count = document.getElementById('notification-count');
            if (upcomingCount > 0) {
                badge.style.display = 'block';
                count.textContent = upcomingCount;
            } else {
                badge.style.display = 'none';
            }

            // Send browser notification for today's releases
            if (releasingToday.length > 0 && Notification.permission === 'granted') {
                const lastNotified = localStorage.getItem('lastNotificationDate');
                const todayStr = today.toISOString().split('T')[0];

                if (lastNotified !== todayStr) {
                    const title = releasingToday.length === 1
                        ? `üéÆ ${releasingToday[0].title} releases TODAY!`
                        : `üéÆ ${releasingToday.length} games release TODAY!`;

                    const body = releasingToday.map(g => g.title).join(', ');

                    new Notification(title, {
                        body: body,
                        icon: releasingToday[0].cover || '',
                        tag: 'game-release'
                    });

                    localStorage.setItem('lastNotificationDate', todayStr);
                }
            }
        }

        // Cover art helper - opens Google Images for manual copy
        function fetchCoverArt() {
            const title = document.getElementById('game-title').value.trim();
            if (!title) {
                alert('Please enter a game title first');
                return;
            }

            // Open Google Images in new tab
            const searchQuery = encodeURIComponent(`${title} video game cover art`);
            window.open(`https://www.google.com/search?q=${searchQuery}&tbm=isch`, '_blank');
        }

        // Show help for cover art feature
        // Tag and Priority Management
        let currentGameTags = [];

        function initializeTagSuggestions() {
            const container = document.getElementById('tag-suggestions');
            container.innerHTML = defaultTags.map(tag => `
                <button type="button" class="tag-suggestion" data-tag="${tag}" onclick="toggleTag('${tag}')" style="padding: 4px 10px; background: #2c3440; color: #9ab; border: 1px solid #3c4450; border-radius: 12px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                    ${tag}
                </button>
            `).join('');
        }

        function toggleTag(tag) {
            const index = currentGameTags.indexOf(tag);
            if (index > -1) {
                // Remove tag
                currentGameTags.splice(index, 1);
            } else {
                // Add tag
                currentGameTags.push(tag);
            }
            updateSelectedTagsDisplay();
            updateTagSuggestionsDisplay();
        }

        function addCustomTag() {
            const input = document.getElementById('tag-input');
            const tag = input.value.trim();
            
            if (!tag) return;
            
            if (currentGameTags.includes(tag)) {
                alert('Tag already added');
                return;
            }
            
            currentGameTags.push(tag);
            input.value = '';
            updateSelectedTagsDisplay();
        }

        function removeTag(tag) {
            const index = currentGameTags.indexOf(tag);
            if (index > -1) {
                currentGameTags.splice(index, 1);
                updateSelectedTagsDisplay();
                updateTagSuggestionsDisplay();
            }
        }

        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selected-tags');
            if (currentGameTags.length === 0) {
                container.innerHTML = '<span style="color: #678; font-size: 0.85em;">No tags selected</span>';
            } else {
                container.innerHTML = currentGameTags.map(tag => `
                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #4a9eff; color: #fff; border-radius: 12px; font-size: 0.85em;">
                        ${tag}
                        <button onclick="removeTag('${tag}')" style="background: none; border: none; color: #fff; cursor: pointer; padding: 0; margin: 0; font-size: 1.2em; line-height: 1;" title="Remove tag">√ó</button>
                    </span>
                `).join('');
            }
        }

        function updateTagSuggestionsDisplay() {
            document.querySelectorAll('.tag-suggestion').forEach(button => {
                const tag = button.dataset.tag;
                if (currentGameTags.includes(tag)) {
                    button.style.background = '#4a9eff';
                    button.style.color = '#fff';
                    button.style.borderColor = '#4a9eff';
                } else {
                    button.style.background = '#2c3440';
                    button.style.color = '#9ab';
                    button.style.borderColor = '#3c4450';
                }
            });
        }

        function updateTagFilter() {
            // Collect all unique tags from all games
            const allTags = new Set();
            games.forEach(game => {
                if (game.tags && Array.isArray(game.tags)) {
                    game.tags.forEach(tag => allTags.add(tag));
                }
            });

            const tagFilter = document.getElementById('tag-filter');
            const currentValue = tagFilter.value;
            
            tagFilter.innerHTML = '<option value="all">All Tags</option>';
            Array.from(allTags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue && allTags.has(currentValue)) {
                tagFilter.value = currentValue;
            }
        }

        function togglePriorityField() {
            const status = document.getElementById('game-status').value;
            const priorityGroup = document.getElementById('priority-group');
            
            // Show priority field only for backlog status
            if (status === 'backlog') {
                priorityGroup.style.display = 'block';
            } else {
                priorityGroup.style.display = 'none';
                document.getElementById('game-priority').value = '';
            }
        }

        function showCoverArtHelp() {
            alert('HOW TO FIND COVER ART:\n\n' +
                  '1. Click "üîç Auto-Find Cover Art"\n' +
                  '   ‚Üí Opens Google Images search\n\n' +
                  '2. Click on a cover image you like\n\n' +
                  '3. Right-click the full-size image\n\n' +
                  '4. Choose one:\n' +
                  '   OPTION A: "Copy Image Address"\n' +
                  '   ‚Üí Paste into URL field below\n\n' +
                  '   OPTION B: "Save Image As..."\n' +
                  '   ‚Üí Use file upload button\n\n' +
                  'TIP: If pasted URL doesn\'t load,\n' +
                  'the website blocks linking.\n' +
                  'Use Option B (download & upload) instead!');
        }

        // Steam Search Functions
        function showSteamSearch() {
            document.getElementById('steam-search-input').value = '';
            document.getElementById('steam-search-results').style.display = 'none';
            document.getElementById('steam-search-loading').style.display = 'none';
            document.getElementById('steam-search-modal').classList.add('active');
        }

        function closeSteamSearch() {
            document.getElementById('steam-search-modal').classList.remove('active');
        }

        function handleSteamSearchKeypress(event) {
            if (event.key === 'Enter') {
                searchSteamGames();
            }
        }

        async function searchSteamGames() {
            const searchInput = document.getElementById('steam-search-input').value.trim();
            
            if (!searchInput) {
                alert('Please enter a game name or Steam URL');
                return;
            }

            // Check if it's a Steam store URL
            const urlMatch = searchInput.match(/store\.steampowered\.com\/app\/(\d+)/);
            if (urlMatch) {
                const appId = urlMatch[1];
                await loadSteamGameDetails(appId);
                return;
            }

            // Show loading
            document.getElementById('steam-search-results').style.display = 'none';
            document.getElementById('steam-search-loading').style.display = 'block';

            try {
                // Use SteamSpy API for search (no CORS issues, free, no key needed)
                const searchTerm = encodeURIComponent(searchInput);
                const response = await fetch(`https://steamspy.com/api.php?request=appdetails&q=${searchTerm}`);
                
                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                
                // SteamSpy returns single game or error
                if (data.appid && data.name) {
                    // Single result found
                    displaySteamSearchResults([{ appid: data.appid, name: data.name }]);
                } else {
                    // No exact match, use alternative search via store
                    await searchViaSteamStore(searchInput);
                }

            } catch (error) {
                console.error('Steam search error:', error);
                // Fallback to store search
                await searchViaSteamStore(searchInput);
            }
        }

        async function searchViaSteamStore(searchTerm) {
            try {
                // Search Steam store via proxy
                const storeSearchUrl = `https://store.steampowered.com/api/storesearch/?term=${encodeURIComponent(searchTerm)}&l=english&cc=US`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(storeSearchUrl)}`;
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);

                if (!data.items || data.items.length === 0) {
                    document.getElementById('steam-search-loading').style.display = 'none';
                    alert('No games found. Try a different search term.');
                    return;
                }

                // Convert to our format
                const matches = data.items.slice(0, 20).map(item => ({
                    appid: item.id,
                    name: item.name
                }));

                displaySteamSearchResults(matches);

            } catch (error) {
                console.error('Store search error:', error);
                document.getElementById('steam-search-loading').style.display = 'none';
                alert('Error searching Steam. Please try again.');
            }
        }

        function displaySteamSearchResults(matches) {
            document.getElementById('steam-search-loading').style.display = 'none';
            document.getElementById('steam-search-results').style.display = 'block';
            document.getElementById('steam-search-count').textContent = matches.length;

            const resultsHtml = matches.map(app => `
                <div onclick="loadSteamGameDetails(${app.appid})" style="padding: 12px; border-bottom: 1px solid #2c3440; cursor: pointer; transition: background 0.2s;" 
                     onmouseover="this.style.background='#2c3440'" onmouseout="this.style.background='transparent'">
                    <div style="color: #fff; font-weight: bold; margin-bottom: 4px;">${app.name}</div>
                    <div style="color: #9ab; font-size: 0.85em;">App ID: ${app.appid}</div>
                </div>
            `).join('');

            document.getElementById('steam-search-list').innerHTML = resultsHtml;
        }

        async function loadSteamGameDetails(appId) {
            // Show loading
            document.getElementById('steam-search-results').style.display = 'none';
            document.getElementById('steam-search-loading').style.display = 'block';
            document.querySelector('#steam-search-loading div:last-child').textContent = 'Loading game details...';

            try {
                // Fetch game details from Steam Store API (via proxy for CORS)
                const storeUrl = `https://store.steampowered.com/api/appdetails?appids=${appId}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(storeUrl)}`;
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);

                if (!data[appId] || !data[appId].success) {
                    throw new Error('Game not found or no longer available');
                }

                const gameData = data[appId].data;

                // Close search modal
                closeSteamSearch();

                // Auto-fill the Add Game form
                document.getElementById('game-title').value = gameData.name;
                document.getElementById('game-platform').value = 'PC';
                
                // Show storefront field for PC
                document.getElementById('storefront-group').style.display = 'block';
                document.getElementById('game-storefront').value = 'Steam';

                // Set release date if available (including upcoming games)
                if (gameData.release_date && gameData.release_date.date) {
                    const dateStr = gameData.release_date.date.trim();
                    console.log('Steam release date string:', dateStr);
                    
                    try {
                        let parsedDate = null;
                        
                        // Format 1: Full date like "15 Jan, 2024" or "Jan 15, 2024" or "2024-01-15"
                        if (dateStr.match(/\d{1,2}\s+\w+,?\s+\d{4}/) || dateStr.match(/\w+\s+\d{1,2},?\s+\d{4}/)) {
                            parsedDate = new Date(dateStr);
                        }
                        // Format 2: ISO format "2024-01-15"
                        else if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            parsedDate = new Date(dateStr);
                        }
                        // Format 3: Month and year "Jan 2024" or "January 2024"
                        else if (dateStr.match(/^\w+\s+\d{4}$/)) {
                            parsedDate = new Date(dateStr + ' 1');
                        }
                        // Format 4: Just year "2024"
                        else if (dateStr.match(/^\d{4}$/)) {
                            parsedDate = new Date(`${dateStr}-01-01`);
                        }
                        // Format 5: Day Month Year without comma "15 Jan 2024"
                        else if (dateStr.match(/^\d{1,2}\s+\w+\s+\d{4}$/)) {
                            parsedDate = new Date(dateStr);
                        }
                        
                        // If we successfully parsed a valid date, set it
                        if (parsedDate && !isNaN(parsedDate.getTime())) {
                            const formattedDate = parsedDate.toISOString().split('T')[0];
                            document.getElementById('game-release-date').value = formattedDate;
                            console.log('Parsed release date to:', formattedDate);
                        } else {
                            console.log('Could not parse date, skipping');
                        }
                    } catch (e) {
                        console.error('Error parsing release date:', e);
                    }
                }

                // Set cover art - use library_600x900 for proper vertical poster
                const coverUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/library_600x900.jpg`;
                document.getElementById('game-cover').value = coverUrl;
                updateImagePreview(coverUrl);
                currentImageData = coverUrl;

                // Set free checkbox if game is free (don't set price)
                if (gameData.is_free) {
                    document.getElementById('game-free').checked = true;
                }

                // Extract tags from genres and categories
                currentGameTags = [];
                
                // Add genres as tags
                if (gameData.genres) {
                    currentGameTags = gameData.genres.map(g => g.description);
                }
                
                // Add category-based tags
                if (gameData.categories) {
                    gameData.categories.forEach(cat => {
                        if (cat.description.includes('Multi-player')) currentGameTags.push('Multiplayer');
                        if (cat.description.includes('Single-player')) currentGameTags.push('Single-player');
                        if (cat.description.includes('Co-op')) currentGameTags.push('Co-op');
                        if (cat.description.includes('Local Co-op')) currentGameTags.push('Local Co-op');
                    });
                }
                
                // Remove duplicates
                currentGameTags = [...new Set(currentGameTags)];
                
                // Update tag display
                updateSelectedTagsDisplay();
                updateTagSuggestionsDisplay();

                // Add Steam info to notes
                const developers = gameData.developers ? gameData.developers.join(', ') : '';
                const genres = gameData.genres ? gameData.genres.map(g => g.description).join(', ') : '';
                
                let notes = `From Steam Store\n`;
                if (developers) notes += `Developer: ${developers}\n`;
                if (genres) notes += `Genres: ${genres}`;
                
                document.getElementById('game-notes').value = notes;

                // Scroll to top of form
                document.querySelector('#game-modal .modal-content').scrollTop = 0;

            } catch (error) {
                console.error('Error loading game details:', error);
                document.getElementById('steam-search-loading').style.display = 'none';
                document.getElementById('steam-search-results').style.display = 'block';
                alert('Error loading game details. The game may not be available on Steam Store API.');
            }
        }

        // Steam Import Functions

        function showSteamImport() {
            if (!STEAM_API_KEY) {
                alert('Steam import requires a Steam Web API key.\n\n' +
                      '1. Get a free key at: https://steamcommunity.com/dev/apikey\n' +
                      '2. Add it to the STEAM_API_KEY variable at the top of this file\n' +
                      '3. Reload the page\n\n' +
                      'Setup takes 2 minutes and is completely free!');
                return;
            }

            document.getElementById('steam-input-step').style.display = 'block';
            document.getElementById('steam-preview-step').style.display = 'none';
            document.getElementById('steam-loading').style.display = 'none';
            document.getElementById('steam-input').value = '';
            document.getElementById('steam-import-modal').classList.add('active');
        }

        function closeSteamImport() {
            document.getElementById('steam-import-modal').classList.remove('active');
            steamGamesCache = [];
        }

        async function fetchSteamLibrary() {
            const input = document.getElementById('steam-input').value.trim();
            if (!input) {
                alert('Please enter your Steam profile URL or Steam ID');
                return;
            }

            // Extract Steam ID from various formats
            let steamId = input;
            
            // If it's a URL, extract the ID
            if (input.includes('steamcommunity.com')) {
                // Try to extract custom URL or numeric ID from URL
                const customMatch = input.match(/\/id\/([^\/]+)/);
                const numericMatch = input.match(/\/profiles\/(\d+)/);
                
                if (customMatch) {
                    // Need to resolve custom URL to Steam ID
                    steamId = await resolveVanityURL(customMatch[1]);
                } else if (numericMatch) {
                    steamId = numericMatch[1];
                } else {
                    alert('Could not parse Steam profile URL. Try entering just your Steam ID (numeric).');
                    return;
                }
            }

            // Show loading
            document.getElementById('steam-input-step').style.display = 'none';
            document.getElementById('steam-loading').style.display = 'block';

            try {
                // Fetch owned games using CORS proxy
                const steamUrl = `https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?key=${STEAM_API_KEY}&steamid=${steamId}&include_appinfo=1&include_played_free_games=1&format=json`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(steamUrl)}`;
                
                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    throw new Error('Failed to fetch Steam library. Make sure your profile is public.');
                }

                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                if (!data.response || !data.response.games) {
                    throw new Error('No games found. Make sure your Steam profile is public and Game Details are set to Public.');
                }

                steamGamesCache = data.response.games;
                displaySteamGames(steamGamesCache);

            } catch (error) {
                console.error('Steam API error:', error);
                alert('Error fetching Steam library:\n\n' + error.message + '\n\nMake sure:\n1. Your Steam profile is public\n2. Game Details are set to Public in privacy settings\n3. Your Steam API key is valid\n4. The Steam ID is correct');
                document.getElementById('steam-input-step').style.display = 'block';
                document.getElementById('steam-loading').style.display = 'none';
            }
        }

        async function resolveVanityURL(vanityURL) {
            try {
                const steamUrl = `https://api.steampowered.com/ISteamUser/ResolveVanityURL/v1/?key=${STEAM_API_KEY}&vanityurl=${vanityURL}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(steamUrl)}`;
                
                const response = await fetch(proxyUrl);
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);
                
                if (data.response && data.response.success === 1) {
                    return data.response.steamid;
                } else {
                    throw new Error('Could not resolve Steam profile name');
                }
            } catch (error) {
                throw new Error('Failed to resolve Steam profile. Try using your numeric Steam ID instead.');
            }
        }

        function displaySteamGames(steamGames) {
            document.getElementById('steam-loading').style.display = 'none';
            document.getElementById('steam-preview-step').style.display = 'block';
            
            document.getElementById('steam-count').textContent = steamGames.length;
            
            // Sort by last played (most recent first), never played games at the end
            const sortedGames = [...steamGames].sort((a, b) => {
                const aPlayed = a.rtime_last_played || 0;
                const bPlayed = b.rtime_last_played || 0;
                return bPlayed - aPlayed;
            });
            
            const listHtml = sortedGames.map(game => {
                const playtimeHours = (game.playtime_forever / 60).toFixed(1);
                const coverUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/header.jpg`;
                const hasPlaytime = game.playtime_forever > 0;
                
                // Format last played date
                let lastPlayedText = '';
                if (game.rtime_last_played && game.rtime_last_played > 0) {
                    const lastPlayed = new Date(game.rtime_last_played * 1000);
                    lastPlayedText = lastPlayed.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } else {
                    lastPlayedText = 'Never played';
                }
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #2c3440;">
                        <input type="checkbox" class="steam-game-checkbox" data-appid="${game.appid}" ${hasPlaytime ? 'checked' : ''} style="margin: 0;">
                        <img src="${coverUrl}" alt="${game.name}" style="width: 60px; height: 28px; object-fit: cover; border-radius: 3px;" onerror="this.style.display='none'">
                        <div style="flex: 1; color: #fff;">
                            <div style="font-weight: bold; font-size: 0.9em;">${game.name}</div>
                            <div style="font-size: 0.8em; color: #9ab;">
                                ${playtimeHours}h ‚Ä¢ ${lastPlayedText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('steam-games-list').innerHTML = listHtml;
            updateImportCount();
            
            // Add change listeners
            document.querySelectorAll('.steam-game-checkbox').forEach(cb => {
                cb.addEventListener('change', updateImportCount);
            });
        }

        function toggleAllSteamGames() {
            const checked = document.getElementById('select-all-steam').checked;
            document.querySelectorAll('.steam-game-checkbox').forEach(cb => {
                cb.checked = checked;
            });
            updateImportCount();
        }

        function applySteamFilters() {
            const lastPlayedFilter = document.getElementById('last-played-filter').value;
            const playtimeFilter = document.getElementById('playtime-filter').value;
            
            const now = Date.now() / 1000; // Current time in seconds
            const oneMonthAgo = now - (30 * 24 * 60 * 60);
            const oneYearAgo = now - (365 * 24 * 60 * 60);
            
            let filteredGames = steamGamesCache.filter(game => {
                // Last Played filter
                let lastPlayedMatch = true;
                if (lastPlayedFilter === 'month') {
                    lastPlayedMatch = game.rtime_last_played && game.rtime_last_played >= oneMonthAgo;
                } else if (lastPlayedFilter === 'year') {
                    lastPlayedMatch = game.rtime_last_played && game.rtime_last_played >= oneYearAgo;
                } else if (lastPlayedFilter === 'never') {
                    lastPlayedMatch = !game.rtime_last_played || game.rtime_last_played === 0;
                }
                
                // Playtime filter
                let playtimeMatch = true;
                const hours = game.playtime_forever / 60;
                if (playtimeFilter === 'over1') {
                    playtimeMatch = hours > 1;
                } else if (playtimeFilter === 'over5') {
                    playtimeMatch = hours > 5;
                } else if (playtimeFilter === 'over10') {
                    playtimeMatch = hours > 10;
                } else if (playtimeFilter === 'over30') {
                    playtimeMatch = hours > 30;
                } else if (playtimeFilter === 'over100') {
                    playtimeMatch = hours > 100;
                } else if (playtimeFilter === 'none') {
                    playtimeMatch = hours === 0;
                }
                
                return lastPlayedMatch && playtimeMatch;
            });
            
            displaySteamGames(filteredGames);
        }

        function updateImportCount() {
            const count = document.querySelectorAll('.steam-game-checkbox:checked').length;
            document.getElementById('import-count').textContent = count;
        }

        async function importSelectedSteamGames() {
            const selectedCheckboxes = document.querySelectorAll('.steam-game-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one game to import');
                return;
            }

            const selectedAppIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.appid);
            const selectedGames = steamGamesCache.filter(g => selectedAppIds.includes(g.appid.toString()));

            // Check for duplicates
            const existingTitles = games.map(g => g.title.toLowerCase());
            let importedCount = 0;
            let skippedCount = 0;

            // Show progress
            document.getElementById('steam-preview-step').style.display = 'none';
            document.getElementById('steam-loading').style.display = 'block';
            document.querySelector('#steam-loading div:last-child').textContent = `Importing 0 of ${selectedGames.length} games...`;

            for (let i = 0; i < selectedGames.length; i++) {
                const steamGame = selectedGames[i];
                
                // Update progress
                document.querySelector('#steam-loading div:last-child').textContent = `Importing ${i + 1} of ${selectedGames.length} games...`;
                
                if (existingTitles.includes(steamGame.name.toLowerCase())) {
                    skippedCount++;
                    continue;
                }

                const playtimeHours = (steamGame.playtime_forever / 60).toFixed(1);
                const hasPlaytime = steamGame.playtime_forever > 0;
                
                // Format last played date
                let lastPlayedText = '';
                if (steamGame.rtime_last_played && steamGame.rtime_last_played > 0) {
                    const lastPlayed = new Date(steamGame.rtime_last_played * 1000);
                    lastPlayedText = `Last played: ${lastPlayed.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                } else {
                    lastPlayedText = 'Never played';
                }

                // Fetch game details to get genres/categories for tags
                let gameTags = [];
                try {
                    const storeUrl = `https://store.steampowered.com/api/appdetails?appids=${steamGame.appid}`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(storeUrl)}`;
                    
                    const response = await fetch(proxyUrl);
                    const proxyData = await response.json();
                    const data = JSON.parse(proxyData.contents);
                    
                    if (data[steamGame.appid] && data[steamGame.appid].success) {
                        const gameData = data[steamGame.appid].data;
                        
                        // Extract genres as tags
                        if (gameData.genres) {
                            gameTags = gameData.genres.map(g => g.description);
                        }
                        
                        // Add some category-based tags
                        if (gameData.categories) {
                            const categoryTags = [];
                            gameData.categories.forEach(cat => {
                                if (cat.description.includes('Multi-player')) categoryTags.push('Multiplayer');
                                if (cat.description.includes('Single-player')) categoryTags.push('Single-player');
                                if (cat.description.includes('Co-op')) categoryTags.push('Co-op');
                                if (cat.description.includes('Local Co-op')) categoryTags.push('Local Co-op');
                            });
                            gameTags = [...gameTags, ...categoryTags];
                        }
                        
                        // Remove duplicates
                        gameTags = [...new Set(gameTags)];
                    }
                } catch (error) {
                    console.log(`Could not fetch tags for ${steamGame.name}:`, error);
                    // Continue without tags
                }

                const newGame = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title: steamGame.name,
                    platform: 'PC',
                    storefront: 'Steam',
                    releaseDate: '',
                    dateAddedToLibrary: '', // Leave blank per user request
                    price: '',
                    free: false,
                    ownership: 'owned',
                    status: hasPlaytime ? 'backlog' : 'backlog',
                    priority: '',
                    tags: gameTags,
                    dateStarted: '',
                    dateFinished: '',
                    rating: 0,
                    notes: `Imported from Steam\nTotal playtime: ${playtimeHours} hours\n${lastPlayedText}`,
                    cover: `https://cdn.cloudflare.steamstatic.com/steam/apps/${steamGame.appid}/library_600x900.jpg`,
                    addedDate: new Date().toISOString(),
                    sessions: [],
                    dlcs: [],
                    steamAppId: steamGame.appid,
                    steamPlaytime: playtimeHours,
                    steamLastPlayed: steamGame.rtime_last_played || 0
                };

                games.push(newGame);
                importedCount++;
                
                // Small delay to avoid overwhelming the API
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            await saveData();
            populateCompletedYearFilter();
            checkUpcomingReleases();
            updateTagFilter();
            renderGames();
            updateStats();
            closeSteamImport();

            alert(`Import complete!\n\n‚úÖ Imported: ${importedCount} games\n${skippedCount > 0 ? `‚è≠Ô∏è Skipped: ${skippedCount} (already in library)` : ''}`);
        }

        async function saveSession(event) {
            event.preventDefault();
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            if (!game.sessions) game.sessions = [];

            const sessionData = {
                date: document.getElementById('session-date').value,
                duration: document.getElementById('session-duration').value,
                progress: document.getElementById('session-progress').value,
                notes: document.getElementById('session-notes').value
            };

            if (currentEditSessionId) {
                // Edit existing session
                const index = game.sessions.findIndex(s => s.id === currentEditSessionId);
                if (index !== -1) {
                    game.sessions[index] = { ...game.sessions[index], ...sessionData };
                }
                currentEditSessionId = null;
            } else {
                // Add new session
                const session = {
                    id: Date.now().toString(),
                    ...sessionData
                };
                game.sessions.push(session);
            }

            await saveData();
            updateStats();
            closeSessionModal();
            showGameDetail(currentGameId);
        }

        function editSession(sessionId) {
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;
            
            const session = game.sessions.find(s => s.id === sessionId);
            if (!session) return;

            currentEditSessionId = sessionId;
            
            document.getElementById('session-date').value = session.date;
            document.getElementById('session-duration').value = session.duration || '';
            document.getElementById('session-progress').value = session.progress || '';
            document.getElementById('session-notes').value = session.notes || '';
            
            document.getElementById('session-modal').classList.add('active');
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this play session?')) return;
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            game.sessions = game.sessions.filter(s => s.id !== sessionId);
            await saveData();
            updateStats();
            showGameDetail(currentGameId);
        }

        function exportData() {
            const exportData = {
                version: APP_VERSION,
                exportDate: new Date().toISOString(),
                games: games
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `game-library-v${APP_VERSION}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    let importedGames = [];
                    let importVersion = 'unknown';
                    
                    if (Array.isArray(imported)) {
                        importedGames = imported;
                        importVersion = 'pre-1.0';
                    } else if (imported.games && Array.isArray(imported.games)) {
                        importedGames = imported.games;
                        importVersion = imported.version || 'unknown';
                    } else {
                        throw new Error('Invalid file format');
                    }
                    
                    if (confirm(`Import ${importedGames.length} games from version ${importVersion}?\n\nThis will replace your current library.`)) {
                        games = importedGames.map(migrateGameData);
                        await saveData();
                        renderGames();
                        updateStats();
                        alert('Import successful! Data migrated to v' + APP_VERSION);
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>
