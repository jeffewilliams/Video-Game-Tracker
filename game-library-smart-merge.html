<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #14181c;
            color: #9ab;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1f29;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #00c030;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .stat-item {
            color: #678;
        }

        .stat-item strong {
            color: #00c030;
            font-size: 1.2em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: #00c030;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #00e040;
        }

        button.secondary {
            background: #2c3440;
        }

        button.secondary:hover {
            background: #3c4450;
        }

        input, select, textarea {
            background: #2c3440;
            border: 1px solid #456;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00c030;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .filter-controls input {
            flex: 1;
            max-width: 300px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .game-card {
            background: #1a1f29;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 192, 48, 0.3);
            border-color: #00c030;
        }

        .game-cover {
            width: 100%;
            height: 280px;
            object-fit: cover;
            background: #2c3440;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 60px;
            flex-shrink: 0;
        }

        .game-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .game-title {
            color: #fff;
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 8px;
            line-height: 1.3;
            height: 2.6em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .game-meta {
            font-size: 0.85em;
            color: #678;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: auto;
            gap: 8px;
        }

        .game-meta-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }

        .game-playtime {
            font-size: 0.85em;
            color: #9ab;
            white-space: nowrap;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-playing { background: #00c030; color: #fff; }
        .status-completed { background: #0080ff; color: #fff; }
        .status-backlog { background: #ff6b6b; color: #fff; }
        .status-on-deck { background: #9b59b6; color: #fff; }
        .status-wishlist { background: #ffd93d; color: #000; }
        .status-abandoned { background: #666; color: #fff; }

        .rating {
            color: #ff8800;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            max-width: 900px;
            margin: 40px auto;
            background: #1a1f29;
            border-radius: 8px;
            padding: 30px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2c3440;
            color: #fff;
            font-size: 28px;
            padding: 8px 15px;
            border-radius: 4px;
            line-height: 1;
            font-weight: bold;
            z-index: 10;
        }

        .close-modal:hover {
            color: #fff;
            background: #3c4450;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9ab;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .game-detail-header {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .game-detail-cover {
            width: 250px;
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
            background: #2c3440;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 80px;
        }

        .game-detail-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-detail-info h2 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .game-detail-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            background: #2c3440;
            padding: 12px;
            border-radius: 4px;
        }

        .meta-label {
            color: #678;
            font-size: 0.85em;
            margin-bottom: 3px;
        }

        .meta-value {
            color: #fff;
            font-weight: 600;
        }

        .sessions-section {
            margin-top: 30px;
        }

        .sessions-section h3 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-card {
            background: #2c3440;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #00c030;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #9ab;
            font-size: 0.9em;
        }

        .session-date {
            font-weight: 600;
        }

        .session-duration {
            color: #678;
        }

        .session-notes {
            color: #fff;
            line-height: 1.5;
        }

        .session-progress {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #456;
            color: #9ab;
            font-size: 0.85em;
        }

        .session-edit-btn, .session-delete-btn {
            background: none;
            border: none;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 0.9em;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .session-edit-btn:hover, .session-delete-btn:hover {
            opacity: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #678;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 1.5em;
        }

        .star {
            cursor: pointer;
            color: #456;
            transition: color 0.2s;
        }

        .star.active,
        .star:hover {
            color: #ff8800;
        }

        .import-export {
            margin-top: 40px;
            padding: 20px;
            background: #2c3440;
            border-radius: 8px;
        }

        .import-export h3 {
            color: #fff;
            margin-bottom: 15px;
        }

        .delete-btn {
            background: #ff4444;
        }

        .delete-btn:hover {
            background: #ff6666;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3440;
        }

        .section-header h2 {
            color: #fff;
            font-size: 1.5em;
            margin: 0;
        }

        .section-count {
            color: #00c030;
            font-size: 0.9em;
            font-weight: 600;
        }

        .expand-button {
            background: #2c3440;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .expand-button:hover {
            background: #3c4450;
        }

        .load-more-container {
            text-align: center;
            margin: 30px 0;
        }

        .load-more-btn {
            padding: 12px 40px;
            font-size: 1em;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 15px 0;
                margin-bottom: 15px;
            }

            h1 {
                font-size: 1.3em;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin-top: 10px;
                font-size: 0.8em;
            }

            .stat-item {
                padding: 8px;
                background: #2c3440;
                border-radius: 4px;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px !important;
            }

            .user-email {
                font-size: 0.75em;
            }

            .sync-status {
                margin-left: 0 !important;
                font-size: 0.8em;
            }

            .controls {
                gap: 8px;
                margin-bottom: 20px;
            }

            .filter-controls {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }

            .filter-controls input,
            .filter-controls select {
                max-width: 100%;
                width: 100%;
                font-size: 14px;
            }

            .section-header {
                margin: 20px 0 12px 0;
                padding-bottom: 8px;
                flex-wrap: wrap;
            }

            .section-header h2 {
                font-size: 1.2em;
                width: 100%;
                margin-bottom: 8px;
            }

            .section-count {
                font-size: 0.85em;
            }

            .game-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 20px;
            }

            .game-card {
                border-radius: 4px;
            }

            .game-cover {
                height: 140px;
            }

            .game-info {
                padding: 8px;
            }

            .game-title {
                font-size: 0.75em;
                line-height: 1.2;
                height: 2.4em;
                margin-bottom: 6px;
            }

            .game-meta {
                font-size: 0.7em;
            }

            .game-meta-left {
                gap: 2px;
            }

            .status-badge {
                font-size: 0.65em;
                padding: 2px 6px;
            }

            .rating {
                font-size: 0.9em;
            }

            .game-playtime {
                font-size: 0.7em;
            }

            .expand-button, #completed-year-filter, #stats-year-filter {
                font-size: 0.8em;
                padding: 6px 10px;
            }

            .load-more-container {
                margin: 20px 0;
            }

            .load-more-btn {
                width: 100%;
                padding: 12px;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
                max-width: 100%;
            }

            .close-modal {
                top: 15px;
                right: 15px;
                font-size: 32px;
                padding: 10px 18px;
                background: #00c030;
            }

            .close-modal:active {
                background: #00a028;
            }

            .game-detail-header {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .game-detail-cover {
                width: 100%;
                height: 300px;
                margin: 0 auto;
            }

            .game-detail-meta {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }

            .image-upload-section {
                flex-direction: column;
            }

            .image-preview {
                width: 100%;
                max-width: 200px;
                height: 250px;
                margin: 0 auto;
            }

            .import-export {
                padding: 15px;
            }

            .import-export > div {
                flex-direction: column !important;
            }

            .import-export button {
                width: 100%;
            }

            button {
                padding: 12px 20px;
                font-size: 16px;
                touch-action: manipulation;
            }

            input, select, textarea {
                font-size: 16px;
                padding: 12px;
            }

            .auth-container {
                margin: 20px;
                padding: 20px;
            }

            .dlc-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .dlc-delete {
                width: 100%;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .game-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .game-cover {
                height: 120px;
            }

            .game-info {
                padding: 6px;
            }

            .game-title {
                font-size: 0.7em;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            h1 {
                font-size: 1.2em;
            }

            .section-header h2 {
                font-size: 1.1em;
            }
        }

        /* Tablet landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .game-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button, .game-card, .star {
                cursor: default;
            }

            button:active {
                background: #00a028;
            }

            button.secondary:active {
                background: #4c5460;
            }

            .game-card:active {
                transform: scale(0.98);
            }
        }

        .storefront-section {
            margin-top: 10px;
        }

        select[multiple] {
            padding: 8px;
            min-height: 120px;
        }

        select[multiple] option {
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        select[multiple] option:checked {
            background: #00c030 linear-gradient(0deg, #00c030 0%, #00c030 100%);
            color: #fff;
        }

        .image-upload-section {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .image-preview {
            width: 120px;
            height: 160px;
            background: #1a1f29;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #456;
            font-size: 40px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dlc-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .dlc-item {
            background: #2c3440;
            padding: 12px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dlc-info {
            flex: 1;
        }

        .dlc-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .dlc-meta {
            font-size: 0.85em;
            color: #678;
        }

        .dlc-delete {
            background: #ff4444;
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .add-dlc-form {
            background: #2c3440;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .add-dlc-form input {
            margin-bottom: 10px;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: #1a1f29;
            border-radius: 8px;
        }

        .auth-container h2 {
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: #2c3440;
            border: none;
            color: #9ab;
            cursor: pointer;
            border-radius: 4px;
        }

        .auth-tab.active {
            background: #00c030;
            color: #fff;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 15px;
        }

        .sync-status.syncing {
            background: #ff8800;
            color: #fff;
        }

        .sync-status.synced {
            background: #00c030;
            color: #fff;
        }

        .sync-status.error {
            background: #ff4444;
            color: #fff;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-email {
            color: #9ab;
            font-size: 0.9em;
        }

        #auth-error {
            color: #ff4444;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Auth Container (shown when not logged in) -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <h2>üéÆ Game Library</h2>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>

        <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" style="width: 100%;">Login</button>
            <div id="auth-error"></div>
        </form>

        <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signup-email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signup-password" required minlength="6">
            </div>
            <button type="submit" style="width: 100%;">Sign Up</button>
            <div id="auth-error-signup"></div>
            <p style="color: #678; font-size: 0.85em; margin-top: 10px; text-align: center;">
                You'll receive a confirmation email. Click the link to activate your account.
            </p>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #2c3440;">
            <button onclick="skipLogin()" class="secondary" style="width: 100%;">Continue Offline (No Sync)</button>
            <p style="color: #678; font-size: 0.8em; margin-top: 10px;">
                Use locally with browser storage. Login anytime to sync across devices.
            </p>
        </div>
    </div>

    <!-- Main App (shown when logged in) -->
    <div id="main-app" style="display: none;">
    <header>
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üéÆ Game Library</h1>
                    <div class="user-info">
                        <span class="user-email" id="user-email"></span>
                        <span class="sync-status" id="sync-status">Synced</span>
                        <button id="login-btn" class="secondary" onclick="showLoginModal()" style="padding: 5px 15px; font-size: 0.85em; display: none;">Login to Sync</button>
                        <button id="logout-btn" class="secondary" onclick="handleLogout()" style="padding: 5px 15px; font-size: 0.85em;">Logout</button>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="color: #9ab; font-size: 0.9em;">Stats for:</label>
                    <select id="stats-year-filter" onchange="updateStatsFilter()" style="padding: 8px 12px;">
                        <option value="all">All Time</option>
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <strong id="total-games">0</strong> games
                </div>
                <div class="stat-item">
                    <strong id="total-sessions">0</strong> sessions
                </div>
                <div class="stat-item">
                    <strong id="total-hours">0</strong> hours
                </div>
                <div class="stat-item">
                    <strong id="total-spent">$0</strong> spent
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <button onclick="showAddGameModal()">+ Add Game</button>
            <div class="filter-controls">
                <input type="text" id="search-input" placeholder="Search games..." oninput="filterGames()">
                <select id="status-filter" onchange="filterGames()">
                    <option value="all">All Status</option>
                    <option value="playing">Playing</option>
                    <option value="on-deck">On Deck</option>
                    <option value="completed">Completed</option>
                    <option value="backlog">Backlog</option>
                    <option value="wishlist">Wishlist</option>
                    <option value="abandoned">Abandoned</option>
                </select>
                <select id="sort-select" onchange="filterGames()">
                    <option value="title">Sort by Title</option>
                    <option value="recent">Recently Added</option>
                    <option value="recently-played">Recently Played</option>
                    <option value="rating">Highest Rated</option>
                    <option value="playtime">Most Played</option>
                </select>
            </div>
        </div>

        <!-- Playing Now Section -->
        <div class="section-header">
            <h2>üéÆ Currently Playing</h2>
            <span class="section-count" id="playing-count">0 games</span>
        </div>
        <div id="playing-grid" class="game-grid"></div>

        <!-- On Deck Section -->
        <div class="section-header">
            <h2>‚è≠Ô∏è On Deck</h2>
            <span class="section-count" id="ondeck-count">0 games</span>
        </div>
        <div id="ondeck-grid" class="game-grid"></div>

        <!-- Completed Section -->
        <div class="section-header">
            <h2>‚úÖ Completed</h2>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="section-count" id="completed-count">0 in 2026</span>
                <select id="completed-year-filter" onchange="filterCompletedYear()" style="padding: 6px 12px;">
                    <option value="all">All Years</option>
                </select>
            </div>
        </div>
        <div id="completed-grid" class="game-grid"></div>

        <!-- Full Library Section -->
        <div class="section-header">
            <h2>üìö Full Library</h2>
            <span class="section-count" id="library-count">0 games</span>
        </div>
        <div id="library-grid" class="game-grid" style="display: none;"></div>
        <div class="load-more-container">
            <button class="load-more-btn" id="load-library-btn" onclick="toggleLibrary()">Load Full Library</button>
        </div>

        <div class="import-export">
            <h3>Data Management</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="exportData()">Export Library</button>
                <button onclick="document.getElementById('import-file').click()" class="secondary">Import Library</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>
    </div> <!-- End main-app -->

    <!-- Add/Edit Game Modal -->
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeGameModal()">√ó</button>
            <h2 id="modal-title" style="color: #fff; margin-bottom: 20px;">Add Game</h2>
            <form id="game-form" onsubmit="saveGame(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="game-title" required>
                </div>

                <div class="form-group">
                    <label>Cover Image</label>
                    <div class="image-upload-section">
                        <div class="image-preview" id="image-preview">üéÆ</div>
                        <div class="image-controls">
                            <input type="url" id="game-cover" placeholder="Or paste image URL">
                            <input type="file" id="game-cover-upload" accept="image/*" onchange="handleImageUpload(event)">
                            <button type="button" class="secondary" onclick="clearImage()">Clear Image</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Platform *</label>
                    <select id="game-platform" required>
                        <option value="">Select platform...</option>
                        <option value="PC">PC</option>
                        <option value="PlayStation 5">PlayStation 5</option>
                        <option value="PlayStation 4">PlayStation 4</option>
                        <option value="Xbox Series X/S">Xbox Series X/S</option>
                        <option value="Xbox One">Xbox One</option>
                        <option value="Nintendo Switch">Nintendo Switch</option>
                        <option value="Steam Deck">Steam Deck</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Retro/Other">Retro/Other</option>
                    </select>
                </div>

                <div class="form-group" id="storefront-group" style="display: none;">
                    <label>PC Storefront</label>
                    <select id="game-storefront">
                        <option value="">Select storefront...</option>
                        <option value="Steam">Steam</option>
                        <option value="Epic Games">Epic Games</option>
                        <option value="GOG">GOG</option>
                        <option value="Xbox Game Pass">Xbox Game Pass</option>
                        <option value="EA App">EA App</option>
                        <option value="Ubisoft Connect">Ubisoft Connect</option>
                        <option value="Battle.net">Battle.net</option>
                        <option value="Itch.io">Itch.io</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="game-release-date">
                </div>

                <div class="form-group">
                    <label>Date Added to Library *</label>
                    <input type="date" id="game-date-added" required>
                </div>

                <div class="form-group">
                    <label>Purchase Price ($)</label>
                    <input type="number" id="game-price" step="0.01" min="0" placeholder="59.99">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="game-free" style="width: auto; margin: 0;">
                        <span>Received for free</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Ownership *</label>
                    <select id="game-ownership" required>
                        <option value="owned">Owned</option>
                        <option value="streamed">Streamed (Game Pass, PS Plus, etc.)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Status *</label>
                    <select id="game-status" required>
                        <option value="wishlist">Wishlist</option>
                        <option value="backlog">Backlog</option>
                        <option value="on-deck">On Deck</option>
                        <option value="playing">Playing</option>
                        <option value="completed">Completed</option>
                        <option value="abandoned">Abandoned</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date Started</label>
                    <input type="date" id="game-started">
                </div>

                <div class="form-group">
                    <label>Date Finished/Put Down</label>
                    <input type="date" id="game-finished">
                </div>

                <div class="form-group">
                    <label>Rating</label>
                    <div class="star-rating" id="game-rating-input">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <input type="hidden" id="game-rating" value="0">
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="game-notes" placeholder="Your thoughts about this game..."></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save Game</button>
                    <button type="button" class="secondary" onclick="closeGameModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Game Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <button class="close-modal" onclick="closeDetailModal()">√ó</button>
            <div id="game-detail-content"></div>
        </div>
    </div>

    <!-- Add DLC Modal -->
    <div id="dlc-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeDlcModal()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">Add DLC</h2>
            <form id="dlc-form" onsubmit="saveDlc(event)">
                <div class="form-group">
                    <label>DLC Name *</label>
                    <input type="text" id="dlc-name" required>
                </div>
                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="dlc-release-date">
                </div>
                <div class="form-group">
                    <label>Purchase Price ($)</label>
                    <input type="number" id="dlc-price" step="0.01" min="0" placeholder="19.99">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="dlc-notes" placeholder="What's included in this DLC?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save DLC</button>
                    <button type="button" class="secondary" onclick="closeDlcModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Session Modal -->
    <div id="session-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessionModal()">√ó</button>
            <h2 style="color: #fff; margin-bottom: 20px;">Log Play Session</h2>
            <form id="session-form" onsubmit="saveSession(event)">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="session-date" required>
                </div>
                <div class="form-group">
                    <label>Duration (hours)</label>
                    <input type="number" id="session-duration" step="0.5" min="0" placeholder="2.5">
                </div>
                <div class="form-group">
                    <label>Progress/Achievements</label>
                    <input type="text" id="session-progress" placeholder="Reached level 50, defeated final boss, etc.">
                </div>
                <div class="form-group">
                    <label>Session Notes</label>
                    <textarea id="session-notes" placeholder="What did you think about this session?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit">Save Session</button>
                    <button type="button" class="secondary" onclick="closeSessionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const APP_VERSION = "1.0";
        
        // REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://lryzoqxeoflsyzaphzqh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyeXpvcXhlb2Zsc3l6YXBoenFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTM0MzEsImV4cCI6MjA4NDE4OTQzMX0.9SeOZZCWkcvLmTrt58j58I83UN5yrcetufTQKxMUG9g';
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let games = [];
        let currentGameId = null;
        let currentEditGameId = null;
        let currentEditSessionId = null;
        let currentImageData = null;
        let currentUser = null;
        let isSyncing = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showMainApp(true); // true = logged in
                await loadData();
                populateCompletedYearFilter();
                renderGames();
                updateStats();
            } else {
                // Start in offline mode by default
                showMainApp(false); // false = offline mode
                loadDataOffline();
                populateCompletedYearFilter();
                renderGames();
                updateStats();
            }
            
            setupRatingInput();
            setupPlatformWatcher();
            
            // Set today's date as default for session
            document.getElementById('session-date').valueAsDate = new Date();

            // Watch for image URL changes
            document.getElementById('game-cover').addEventListener('input', function() {
                updateImagePreview(this.value);
            });

            // Listen for auth state changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    showMainApp(true); // Logged in
                    loadData().then(() => {
                        populateCompletedYearFilter();
                        renderGames();
                        updateStats();
                    });
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showMainApp(false); // Switch to offline mode
                    loadDataOffline();
                    populateCompletedYearFilter();
                    renderGames();
                    updateStats();
                }
            });
        });

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        function showMainApp(isLoggedIn) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            if (isLoggedIn && currentUser) {
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('sync-status').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('login-btn').style.display = 'none';
            } else {
                document.getElementById('user-email').textContent = 'Offline Mode';
                document.getElementById('sync-status').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('login-btn').style.display = 'inline-block';
            }
        }

        function showLoginModal() {
            document.getElementById('auth-container').style.display = 'block';
        }

        function loadDataOffline() {
            const stored = localStorage.getItem('gameLibrary');
            if (stored) {
                const data = JSON.parse(stored);
                games = Array.isArray(data) ? data.map(migrateGameData) : 
                        data.games ? data.games.map(migrateGameData) : [];
            } else {
                games = [];
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('signup-form').classList.add('active');
            }
            
            document.getElementById('auth-error').textContent = '';
            document.getElementById('auth-error-signup').textContent = '';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                document.getElementById('auth-error').textContent = error.message;
            } else {
                // Success - auth state change will handle the rest
                document.getElementById('auth-container').style.display = 'none';
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password
            });
            
            if (error) {
                document.getElementById('auth-error-signup').textContent = error.message;
            } else {
                alert('Check your email for the confirmation link!');
                switchAuthTab('login');
            }
        }

        function skipLogin() {
            document.getElementById('auth-container').style.display = 'none';
            showMainApp(false); // Offline mode
            loadDataOffline();
            populateCompletedYearFilter();
            renderGames();
            updateStats();
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            // Auth state change will handle switching to offline mode
        }

        function setSyncStatus(status) {
            const statusEl = document.getElementById('sync-status');
            statusEl.className = 'sync-status ' + status;
            statusEl.textContent = status === 'syncing' ? 'Syncing...' : 
                                   status === 'synced' ? 'Synced' : 
                                   'Sync Error';
        }

        function setupPlatformWatcher() {
            const platformSelect = document.getElementById('game-platform');
            platformSelect.addEventListener('change', function() {
                const pcSelected = this.value === 'PC';
                document.getElementById('storefront-group').style.display = pcSelected ? 'block' : 'none';
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                updateImagePreview(currentImageData);
                document.getElementById('game-cover').value = '';
            };
            reader.readAsDataURL(file);
        }

        function updateImagePreview(src) {
            const preview = document.getElementById('image-preview');
            if (src) {
                preview.innerHTML = `<img src="${src}" alt="Preview">`;
            } else {
                preview.innerHTML = 'üéÆ';
            }
        }

        function clearImage() {
            currentImageData = null;
            document.getElementById('game-cover').value = '';
            document.getElementById('game-cover-upload').value = '';
            updateImagePreview(null);
        }

        function setupRatingInput() {
            const stars = document.querySelectorAll('#game-rating-input .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.getElementById('game-rating').value = rating;
                    updateStarDisplay(rating);
                });
            });
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#game-rating-input .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                setSyncStatus('syncing');
                
                // Load from Supabase
                const { data, error } = await supabaseClient
                    .from('games')
                    .select('data')
                    .eq('user_id', currentUser.id)
                    .single();
                
                // Also load from localStorage
                const stored = localStorage.getItem('gameLibrary');
                let localGames = [];
                if (stored) {
                    const localData = JSON.parse(stored);
                    localGames = Array.isArray(localData) ? localData.map(migrateGameData) : 
                            localData.games ? localData.games.map(migrateGameData) : [];
                }
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                    console.error('Error loading data:', error);
                    setSyncStatus('error');
                    
                    // Fall back to localStorage
                    games = localGames;
                } else if (data) {
                    // Supabase has data - merge with localStorage
                    const parsed = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                    const cloudGames = Array.isArray(parsed) ? parsed.map(migrateGameData) : 
                            parsed.games ? parsed.games.map(migrateGameData) : [];
                    
                    // Merge: combine cloud + local, removing duplicates by title
                    games = mergeGames(cloudGames, localGames);
                    
                    // If we merged new games from localStorage, save back to cloud
                    if (games.length > cloudGames.length) {
                        console.log(`Merged ${games.length - cloudGames.length} games from localStorage into cloud`);
                        await saveData(); // Sync merged data to cloud
                    }
                    
                    setSyncStatus('synced');
                } else {
                    // No data in Supabase yet - use localStorage and sync to cloud
                    console.log('First login - migrating localStorage to cloud');
                    games = localGames;
                    if (games.length > 0) {
                        await saveData(); // Sync to cloud
                    } else {
                        setSyncStatus('synced');
                    }
                }
            } catch (err) {
                console.error('Load error:', err);
                setSyncStatus('error');
            }
        }

        function mergeGames(cloudGames, localGames) {
            // Create a map of cloud games by ID
            const gamesMap = new Map();
            cloudGames.forEach(game => gamesMap.set(game.id, game));
            
            // Add local games that don't exist in cloud (by ID)
            localGames.forEach(localGame => {
                if (!gamesMap.has(localGame.id)) {
                    console.log(`Adding local game to merged library: ${localGame.title}`);
                    gamesMap.set(localGame.id, localGame);
                }
            });
            
            return Array.from(gamesMap.values());
        }

        function migrateGameData(game) {
            // Migrate old storefronts array to single storefront
            if (game.storefronts && Array.isArray(game.storefronts)) {
                game.storefront = game.storefronts[0] || '';
                delete game.storefronts;
            }
            
            // Migrate old platforms array to single platform
            let platform = game.platform;
            if (!platform && game.platforms && Array.isArray(game.platforms)) {
                platform = game.platforms[0] || '';
            }
            
            return {
                id: game.id || Date.now().toString(),
                title: game.title || 'Untitled',
                platform: platform || '',
                storefront: game.storefront || '',
                releaseDate: game.releaseDate || game.year ? `${game.year}-01-01` : '',
                dateAddedToLibrary: game.dateAddedToLibrary || game.addedDate || new Date().toISOString().split('T')[0],
                price: game.price || '',
                free: game.free || false,
                ownership: game.ownership || 'owned',
                status: game.status || 'backlog',
                dateStarted: game.dateStarted || '',
                dateFinished: game.dateFinished || '',
                rating: game.rating || 0,
                notes: game.notes || '',
                cover: game.cover || '',
                addedDate: game.addedDate || new Date().toISOString(),
                sessions: game.sessions || [],
                dlcs: game.dlcs || []
            };
        }

        async function saveData() {
            const data = {
                version: APP_VERSION,
                games: games
            };
            
            // Always save to localStorage (works offline and as backup)
            localStorage.setItem('gameLibrary', JSON.stringify(data));
            
            // If logged in, also sync to Supabase
            if (!currentUser) {
                console.log('saveData: Offline mode - saved to localStorage only');
                return;
            }
            
            if (isSyncing) {
                console.log('saveData: Already syncing, skipping');
                return;
            }
            isSyncing = true;
            
            try {
                setSyncStatus('syncing');
                
                console.log('saveData: Attempting to save', games.length, 'games to Supabase');
                console.log('saveData: User ID:', currentUser.id);
                
                // Save to Supabase
                const { error } = await supabaseClient
                    .from('games')
                    .upsert({
                        id: currentUser.id, // Use user ID as primary key
                        user_id: currentUser.id,
                        data: data,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('Supabase save error:', error);
                    console.error('Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    setSyncStatus('error');
                } else {
                    console.log('saveData: Successfully saved to Supabase');
                    console.log('saveData: First game platform:', games[0]?.platform);
                    console.log('saveData: First game platforms?:', games[0]?.platforms);
                    setSyncStatus('synced');
                }
                
            } catch (err) {
                console.error('Save error (catch block):', err);
                setSyncStatus('error');
            } finally {
                isSyncing = false;
            }
        }

        let completedYearFilter = new Date().getFullYear().toString();
        let libraryLoaded = false;

        function renderGames() {
            const filtered = getFilteredGames();
            
            // Separate games by status
            const playing = filtered.filter(g => g.status === 'playing');
            const onDeck = filtered.filter(g => g.status === 'on-deck');
            const completed = filtered.filter(g => g.status === 'completed');
            const library = filtered; // Show ALL games in library
            
            // Filter completed by selected year
            const completedFiltered = completedYearFilter === 'all' ? completed : completed.filter(g => {
                if (!g.dateFinished) return false;
                return new Date(g.dateFinished).getFullYear() === parseInt(completedYearFilter);
            });
            
            // Render each section
            renderSection('playing-grid', playing, 'playing-count');
            renderSection('ondeck-grid', onDeck, 'ondeck-count');
            renderCompletedSection(completedFiltered, completed.length);
            
            // Update library count but don't render unless loaded
            document.getElementById('library-count').textContent = `${library.length} games`;
            if (libraryLoaded) {
                renderSection('library-grid', library, 'library-count');
            }
        }

        function renderSection(gridId, gamesArray, countId) {
            const grid = document.getElementById(gridId);
            
            if (gamesArray.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p style="color: #678;">No games in this section</p>
                    </div>
                `;
                if (countId) {
                    document.getElementById(countId).textContent = '0 games';
                }
                return;
            }

            grid.innerHTML = gamesArray.map(game => createGameCard(game)).join('');
            
            if (countId) {
                document.getElementById(countId).textContent = `${gamesArray.length} game${gamesArray.length !== 1 ? 's' : ''}`;
            }
        }

        function renderCompletedSection(gamesArray, totalCompleted) {
            const grid = document.getElementById('completed-grid');
            
            if (gamesArray.length === 0) {
                const yearText = completedYearFilter === 'all' ? '' : 'in ' + completedYearFilter;
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p style="color: #678;">No completed games ${yearText}</p>
                    </div>
                `;
                document.getElementById('completed-count').textContent = completedYearFilter === 'all' ? '0 total' : '0 in ' + completedYearFilter;
                return;
            }

            grid.innerHTML = gamesArray.map(game => createGameCard(game)).join('');
            
            const countText = completedYearFilter === 'all' 
                ? `${gamesArray.length} total` 
                : `${gamesArray.length} in ${completedYearFilter}`;
            document.getElementById('completed-count').textContent = countText;
        }

        function createGameCard(game) {
            const playtime = getTotalPlaytime(game);
            return `
                <div class="game-card" onclick="showGameDetail('${game.id}')">
                    <div class="game-cover">
                        ${game.cover ? `<img src="${game.cover}" alt="${game.title}">` : 'üéÆ'}
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                        <div class="game-meta">
                            <div class="game-meta-left">
                                <span class="status-badge status-${game.status}">${game.status}</span>
                                ${playtime > 0 ? `<span class="game-playtime">‚è±Ô∏è ${playtime.toFixed(1)}h</span>` : ''}
                            </div>
                            ${game.rating > 0 ? `<span class="rating">${'‚òÖ'.repeat(game.rating)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleLibrary() {
            libraryLoaded = !libraryLoaded;
            const grid = document.getElementById('library-grid');
            const btn = document.getElementById('load-library-btn');
            
            if (libraryLoaded) {
                grid.style.display = 'grid';
                btn.textContent = 'Hide Full Library';
                renderGames(); // Re-render to populate library
            } else {
                grid.style.display = 'none';
                btn.textContent = 'Load Full Library';
            }
        }

        function getFilteredGames() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            const sort = document.getElementById('sort-select').value;

            let filtered = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(search) ||
                                    (game.platform && game.platform.toLowerCase().includes(search));
                const matchesStatus = status === 'all' || game.status === status;
                return matchesSearch && matchesStatus;
            });

            switch(sort) {
                case 'title':
                    filtered.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'recent':
                    filtered.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate));
                    break;
                case 'recently-played':
                    filtered.sort((a, b) => {
                        const aLastPlayed = getLastPlayedDate(a);
                        const bLastPlayed = getLastPlayedDate(b);
                        // Games never played go to the end
                        if (!aLastPlayed && !bLastPlayed) return 0;
                        if (!aLastPlayed) return 1;
                        if (!bLastPlayed) return -1;
                        return new Date(bLastPlayed) - new Date(aLastPlayed);
                    });
                    break;
                case 'rating':
                    filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'playtime':
                    filtered.sort((a, b) => getTotalPlaytime(b) - getTotalPlaytime(a));
                    break;
            }

            return filtered;
        }

        function getLastPlayedDate(game) {
            if (!game.sessions || game.sessions.length === 0) return null;
            // Find the most recent session date
            const sortedSessions = [...game.sessions].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            return sortedSessions[0].date;
        }

        function getTotalPlaytime(game) {
            if (!game.sessions) return 0;
            return game.sessions.reduce((sum, session) => sum + (parseFloat(session.duration) || 0), 0);
        }

        function getTotalPrice(game) {
            let total = parseFloat(game.price) || 0;
            if (game.dlcs) {
                total += game.dlcs.reduce((sum, dlc) => sum + (parseFloat(dlc.price) || 0), 0);
            }
            return total;
        }

        function filterGames() {
            renderGames();
        }

        function updateStats() {
            const yearFilter = document.getElementById('stats-year-filter').value;
            
            let filteredGames = games;
            let totalSessions = 0;
            let totalHours = 0;
            let totalSpent = 0;
            
            if (yearFilter === 'all') {
                // All time stats
                filteredGames = games;
                
                games.forEach(game => {
                    if (game.sessions) {
                        totalSessions += game.sessions.length;
                        totalHours += getTotalPlaytime(game);
                    }
                    totalSpent += getTotalPrice(game);
                });
            } else {
                // Specific year stats
                const year = parseInt(yearFilter);
                
                // Games: by dateAddedToLibrary year
                filteredGames = games.filter(game => {
                    if (!game.dateAddedToLibrary) return false;
                    const addedYear = new Date(game.dateAddedToLibrary).getFullYear();
                    return addedYear === year;
                });
                
                // Sessions & Hours: by session date year
                games.forEach(game => {
                    if (game.sessions) {
                        game.sessions.forEach(session => {
                            if (session.date) {
                                const sessionYear = new Date(session.date).getFullYear();
                                if (sessionYear === year) {
                                    totalSessions++;
                                    totalHours += parseFloat(session.duration) || 0;
                                }
                            }
                        });
                    }
                });
                
                // Spent: sum of games added in that year
                filteredGames.forEach(game => {
                    totalSpent += getTotalPrice(game);
                });
            }
            
            document.getElementById('total-games').textContent = filteredGames.length;
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('total-spent').textContent = '$' + totalSpent.toFixed(2);
        }

        function updateStatsFilter() {
            updateStats();
        }

        function populateCompletedYearFilter() {
            const completedGames = games.filter(g => g.status === 'completed' && g.dateFinished);
            const years = new Set();
            
            completedGames.forEach(game => {
                const year = new Date(game.dateFinished).getFullYear();
                years.add(year);
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a); // Newest first
            const select = document.getElementById('completed-year-filter');
            
            // Keep "All Years" option and add individual years
            select.innerHTML = '<option value="all">All Years</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === new Date().getFullYear()) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Set the current filter value
            const currentYear = new Date().getFullYear();
            if (sortedYears.includes(currentYear)) {
                completedYearFilter = currentYear.toString();
                select.value = currentYear.toString();
            } else {
                completedYearFilter = 'all';
                select.value = 'all';
            }
        }

        function filterCompletedYear() {
            completedYearFilter = document.getElementById('completed-year-filter').value;
            renderGames();
        }

        function getSelectedCheckboxValues(selector) {
            const checkboxes = document.querySelectorAll(selector + ':checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function setCheckboxValues(selector, values) {
            document.querySelectorAll(selector).forEach(cb => {
                cb.checked = values && values.includes(cb.value);
            });
        }

        function showAddGameModal() {
            currentEditGameId = null;
            currentImageData = null;
            document.getElementById('modal-title').textContent = 'Add Game';
            document.getElementById('game-form').reset();
            document.getElementById('game-date-added').valueAsDate = new Date(); // Default to today
            updateStarDisplay(0);
            updateImagePreview(null);
            document.getElementById('storefront-group').style.display = 'none';
            document.getElementById('game-modal').classList.add('active');
        }

        function closeGameModal() {
            document.getElementById('game-modal').classList.remove('active');
        }

        async function saveGame(event) {
            event.preventDefault();
            
            const platform = document.getElementById('game-platform').value;
            const storefront = document.getElementById('game-storefront').value;

            console.log('Saving platform:', platform);

            if (!platform) {
                alert('Please select a platform');
                return;
            }

            const gameData = {
                title: document.getElementById('game-title').value,
                platform: platform,
                storefront: platform === 'PC' ? storefront : '',
                releaseDate: document.getElementById('game-release-date').value,
                dateAddedToLibrary: document.getElementById('game-date-added').value,
                price: document.getElementById('game-price').value,
                free: document.getElementById('game-free').checked,
                ownership: document.getElementById('game-ownership').value,
                status: document.getElementById('game-status').value,
                dateStarted: document.getElementById('game-started').value,
                dateFinished: document.getElementById('game-finished').value,
                rating: parseInt(document.getElementById('game-rating').value),
                notes: document.getElementById('game-notes').value,
                cover: currentImageData || document.getElementById('game-cover').value,
            };

            console.log('GameData being saved:', gameData);

            if (currentEditGameId) {
                const index = games.findIndex(g => g.id === currentEditGameId);
                const oldGame = games[index];
                
                // Remove old 'platforms' field if it exists
                const { platforms, ...gameWithoutPlatforms } = oldGame;
                
                games[index] = { ...gameWithoutPlatforms, ...gameData };
                console.log('Updated game:', games[index]);
                console.log('Updated game platform field:', games[index].platform);
                console.log('Updated game has platforms field?:', games[index].platforms);
            } else {
                const newGame = {
                    ...gameData,
                    id: Date.now().toString(),
                    addedDate: new Date().toISOString(),
                    sessions: [],
                    dlcs: []
                };
                games.push(newGame);
                console.log('New game added:', newGame);
            }

            await saveData();
            populateCompletedYearFilter(); // Update year dropdown
            renderGames();
            updateStats();
            closeGameModal();
        }

        function showGameDetail(gameId) {
            currentGameId = gameId;
            const game = games.find(g => g.id === gameId);
            if (!game) return;

            const totalPlaytime = getTotalPlaytime(game);
            const sessionCount = game.sessions ? game.sessions.length : 0;
            const totalPrice = getTotalPrice(game);
            const dlcCount = game.dlcs ? game.dlcs.length : 0;

            const content = `
                <div class="game-detail-header">
                    <div class="game-detail-cover">
                        ${game.cover ? `<img src="${game.cover}" alt="${game.title}">` : 'üéÆ'}
                    </div>
                    <div class="game-detail-info">
                        <h2>${game.title}</h2>
                        ${game.rating > 0 ? `<div class="rating" style="font-size: 1.5em; margin-bottom: 10px;">${'‚òÖ'.repeat(game.rating)}</div>` : ''}
                        <div class="game-detail-meta">
                            <div class="meta-item">
                                <div class="meta-label">Status</div>
                                <div class="meta-value"><span class="status-badge status-${game.status}">${game.status}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Platform</div>
                                <div class="meta-value">${game.platform || 'N/A'}</div>
                            </div>
                            ${game.storefront ? `
                            <div class="meta-item">
                                <div class="meta-label">Storefront</div>
                                <div class="meta-value">${game.storefront}</div>
                            </div>` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Ownership</div>
                                <div class="meta-value">${game.ownership === 'streamed' ? 'Streamed' : 'Owned'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Release Date</div>
                                <div class="meta-value">${game.releaseDate ? new Date(game.releaseDate).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Purchase Price</div>
                                <div class="meta-value">${game.free ? 'Free' : game.price ? '$' + parseFloat(game.price).toFixed(2) : 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Total Cost (incl. DLC)</div>
                                <div class="meta-value">${game.free ? 'Free' : '$' + totalPrice.toFixed(2)}</div>
                            </div>
                            ${game.dateStarted ? `
                            <div class="meta-item">
                                <div class="meta-label">Started</div>
                                <div class="meta-value">${new Date(game.dateStarted).toLocaleDateString()}</div>
                            </div>` : ''}
                            ${game.dateFinished ? `
                            <div class="meta-item">
                                <div class="meta-label">Finished</div>
                                <div class="meta-value">${new Date(game.dateFinished).toLocaleDateString()}</div>
                            </div>` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Total Playtime</div>
                                <div class="meta-value">${totalPlaytime.toFixed(1)} hours</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Sessions Logged</div>
                                <div class="meta-value">${sessionCount}</div>
                            </div>
                        </div>
                        ${game.notes ? `<div class="meta-item" style="margin-top: 15px;"><div class="meta-label">Notes</div><div class="meta-value">${game.notes}</div></div>` : ''}
                        <div class="action-buttons">
                            <button onclick="showAddSessionModal()">+ Log Session</button>
                            <button onclick="showAddDlcModal()" class="secondary">+ Add DLC</button>
                            <button onclick="editGame('${game.id}')" class="secondary">Edit Game</button>
                            <button onclick="deleteGame('${game.id}')" class="delete-btn">Delete</button>
                        </div>
                    </div>
                </div>

                <div class="sessions-section">
                    <h3>DLC & Expansions (${dlcCount})</h3>
                    ${game.dlcs && game.dlcs.length > 0 ? `
                        <div class="dlc-list">
                            ${game.dlcs.map(dlc => `
                                <div class="dlc-item">
                                    <div class="dlc-info">
                                        <div class="dlc-name">${dlc.name}</div>
                                        <div class="dlc-meta">
                                            ${dlc.releaseDate ? `Released: ${new Date(dlc.releaseDate).toLocaleDateString()}` : ''}
                                            ${dlc.price ? ` ‚Ä¢ $${parseFloat(dlc.price).toFixed(2)}` : ''}
                                        </div>
                                        ${dlc.notes ? `<div class="dlc-meta" style="margin-top: 5px;">${dlc.notes}</div>` : ''}
                                    </div>
                                    <button class="dlc-delete" onclick="deleteDlc('${dlc.id}')">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #678;">No DLC added yet.</p>'}
                </div>
                
                <div class="sessions-section">
                    <h3>Play Sessions (${sessionCount})</h3>
                    ${game.sessions && game.sessions.length > 0 ? `
                        <div class="session-list">
                            ${[...game.sessions].sort((a, b) => {
                                // Sort by date, most recent first
                                const dateA = new Date(a.date);
                                const dateB = new Date(b.date);
                                return dateB - dateA;
                            }).map(session => {
                                // Fix timezone issue by parsing date without time component
                                const dateParts = session.date.split('-');
                                const displayDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                return `
                                <div class="session-card">
                                    <div class="session-header">
                                        <span class="session-date">${displayDate.toLocaleDateString()}</span>
                                        <div style="display: flex; gap: 5px; align-items: center;">
                                            <span class="session-duration">${session.duration ? `${session.duration}h` : ''}</span>
                                            <button onclick="editSession('${session.id}')" class="session-edit-btn" title="Edit">‚úèÔ∏è</button>
                                            <button onclick="deleteSession('${session.id}')" class="session-delete-btn" title="Delete">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    ${session.notes ? `<div class="session-notes">${session.notes}</div>` : ''}
                                    ${session.progress ? `<div class="session-progress">üìä ${session.progress}</div>` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<p style="color: #678;">No sessions logged yet. Start tracking your playtime!</p>'}
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="closeDetailModal()" class="secondary" style="width: 100%; max-width: 300px; padding: 15px;">
                        ‚Üê Back to Library
                    </button>
                </div>
            `;

            document.getElementById('game-detail-content').innerHTML = content;
            document.getElementById('detail-modal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
            currentGameId = null;
        }

        function editGame(gameId) {
            closeDetailModal();
            const game = games.find(g => g.id === gameId);
            if (!game) return;

            currentEditGameId = gameId;
            currentImageData = null;
            document.getElementById('modal-title').textContent = 'Edit Game';
            document.getElementById('game-title').value = game.title;
            
            // Handle migration from old platforms array to single platform
            const platform = Array.isArray(game.platform) ? game.platform[0] : game.platform;
            document.getElementById('game-platform').value = platform || '';
            document.getElementById('game-storefront').value = game.storefront || '';
            
            const pcSelected = platform === 'PC';
            document.getElementById('storefront-group').style.display = pcSelected ? 'block' : 'none';
            
            document.getElementById('game-release-date').value = game.releaseDate || '';
            document.getElementById('game-date-added').value = game.dateAddedToLibrary || new Date().toISOString().split('T')[0];
            document.getElementById('game-price').value = game.price || '';
            document.getElementById('game-free').checked = game.free || false;
            document.getElementById('game-ownership').value = game.ownership || 'owned';
            document.getElementById('game-status').value = game.status;
            document.getElementById('game-started').value = game.dateStarted || '';
            document.getElementById('game-finished').value = game.dateFinished || '';
            document.getElementById('game-rating').value = game.rating || 0;
            document.getElementById('game-notes').value = game.notes || '';
            
            if (game.cover) {
                updateImagePreview(game.cover);
                currentImageData = game.cover;
            }
            
            updateStarDisplay(game.rating || 0);
            
            document.getElementById('game-modal').classList.add('active');
        }

        async function deleteGame(gameId) {
            if (!confirm('Are you sure you want to delete this game and all its sessions?')) return;
            
            games = games.filter(g => g.id !== gameId);
            await saveData();
            renderGames();
            updateStats();
            closeDetailModal();
        }

        function showAddDlcModal() {
            document.getElementById('dlc-form').reset();
            document.getElementById('dlc-modal').classList.add('active');
        }

        function closeDlcModal() {
            document.getElementById('dlc-modal').classList.remove('active');
        }

        async function saveDlc(event) {
            event.preventDefault();
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            if (!game.dlcs) game.dlcs = [];

            const dlc = {
                id: Date.now().toString(),
                name: document.getElementById('dlc-name').value,
                releaseDate: document.getElementById('dlc-release-date').value,
                price: document.getElementById('dlc-price').value,
                notes: document.getElementById('dlc-notes').value
            };

            game.dlcs.push(dlc);
            await saveData();
            updateStats();
            closeDlcModal();
            showGameDetail(currentGameId);
        }

        async function deleteDlc(dlcId) {
            if (!confirm('Are you sure you want to delete this DLC?')) return;
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            game.dlcs = game.dlcs.filter(d => d.id !== dlcId);
            await saveData();
            updateStats();
            showGameDetail(currentGameId);
        }

        function showAddSessionModal() {
            currentEditSessionId = null; // Clear edit mode
            document.getElementById('session-form').reset();
            document.getElementById('session-date').valueAsDate = new Date();
            document.getElementById('session-modal').classList.add('active');
        }

        function closeSessionModal() {
            currentEditSessionId = null; // Clear edit mode on close
            document.getElementById('session-modal').classList.remove('active');
        }

        async function saveSession(event) {
            event.preventDefault();
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            if (!game.sessions) game.sessions = [];

            const sessionData = {
                date: document.getElementById('session-date').value,
                duration: document.getElementById('session-duration').value,
                progress: document.getElementById('session-progress').value,
                notes: document.getElementById('session-notes').value
            };

            if (currentEditSessionId) {
                // Edit existing session
                const index = game.sessions.findIndex(s => s.id === currentEditSessionId);
                if (index !== -1) {
                    game.sessions[index] = { ...game.sessions[index], ...sessionData };
                }
                currentEditSessionId = null;
            } else {
                // Add new session
                const session = {
                    id: Date.now().toString(),
                    ...sessionData
                };
                game.sessions.push(session);
            }

            await saveData();
            updateStats();
            closeSessionModal();
            showGameDetail(currentGameId);
        }

        function editSession(sessionId) {
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;
            
            const session = game.sessions.find(s => s.id === sessionId);
            if (!session) return;

            currentEditSessionId = sessionId;
            
            document.getElementById('session-date').value = session.date;
            document.getElementById('session-duration').value = session.duration || '';
            document.getElementById('session-progress').value = session.progress || '';
            document.getElementById('session-notes').value = session.notes || '';
            
            document.getElementById('session-modal').classList.add('active');
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this play session?')) return;
            
            const game = games.find(g => g.id === currentGameId);
            if (!game) return;

            game.sessions = game.sessions.filter(s => s.id !== sessionId);
            await saveData();
            updateStats();
            showGameDetail(currentGameId);
        }

        function exportData() {
            const exportData = {
                version: APP_VERSION,
                exportDate: new Date().toISOString(),
                games: games
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `game-library-v${APP_VERSION}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    let importedGames = [];
                    let importVersion = 'unknown';
                    
                    if (Array.isArray(imported)) {
                        importedGames = imported;
                        importVersion = 'pre-1.0';
                    } else if (imported.games && Array.isArray(imported.games)) {
                        importedGames = imported.games;
                        importVersion = imported.version || 'unknown';
                    } else {
                        throw new Error('Invalid file format');
                    }
                    
                    if (confirm(`Import ${importedGames.length} games from version ${importVersion}?\n\nThis will replace your current library.`)) {
                        games = importedGames.map(migrateGameData);
                        await saveData();
                        renderGames();
                        updateStats();
                        alert('Import successful! Data migrated to v' + APP_VERSION);
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>
